# æ—¥ç¨‹è¡¨è¯¦ç»†è®¾è®¡æ–‡æ¡£

## æ ¸å¿ƒè®¾è®¡ç†å¿µ

**åŸºäºä¼˜å…ˆçº§çš„é¢œè‰²ç³»ç»Ÿ + è¿ç»­æ¸²æŸ“ + å®Œå…¨å †å èšåˆ**

é€šè¿‡ç²¾ç¡®çš„åˆ†é’Ÿçº§å®šä½å’Œé‡å æ£€æµ‹ç®—æ³•ï¼Œå®ç°æ¸…æ™°ã€ç›´è§‚çš„æ—¥ç¨‹ç®¡ç†ç•Œé¢ã€‚

---

## ä¸€ã€æ ¸å¿ƒåŸåˆ™ä¸å¸ƒå±€

### 1.1 è§†å›¾çª—å£ (Viewport)

- **æ—¶é—´èŒƒå›´**: 8:00 - 21:00 (13å°æ—¶)
- **è¶…å‡ºå¤„ç†**: æ—©äº8:00æˆ–æ™šäº21:00çš„æ´»åŠ¨é€šè¿‡æˆªæ–­æ•ˆæœæ¸²æŸ“

### 1.2 ç½‘æ ¼ç³»ç»Ÿ (Grid System)

- **å‚ç›´æ—¶é—´è½´**: æ¯æ ¼ä»£è¡¨ **1å°æ—¶** (60px)ï¼Œä½†äº‹ä»¶å®šä½ç²¾åº¦ä¸º **1åˆ†é’Ÿ** (1px)
- **å¸ƒå±€**: å·¦ä¾§æ—¶é—´åˆ— + 7ä¸ªå·¥ä½œæ—¥åˆ—
- **å®šä½æœºåˆ¶**: äº‹ä»¶ä½¿ç”¨ç»å¯¹å®šä½ï¼ŒåŸºäºåˆ†é’Ÿçº§ç²¾åº¦è®¡ç®— `top` å’Œ `height`

### 1.3 é¢œè‰²ç³»ç»Ÿ (Color System)

**é¢œè‰²ä»£è¡¨ä¼˜å…ˆçº§ï¼Œè€Œéäº‹ä»¶æœ¬èº«**

| ä¼˜å…ˆçº§ | Priorityå€¼ | é¢œè‰² | è‰²å€¼ |
|--------|-----------|------|------|
| é«˜ä¼˜å…ˆçº§ | 4-5 | çº¢è‰² | #ef4444 |
| ä¸­ä¼˜å…ˆçº§ | 2-3 | è“è‰² | #3b82f6 |
| ä½ä¼˜å…ˆçº§ | 0-1 | ç»¿è‰² | #10b981 |
| èšåˆå— | - | ç°è‰² | #e5e7eb |

### 1.4 é‡å ç­–ç•¥ (Overlap Strategy)

- **ç­–ç•¥åç§°**: å®Œå…¨å †å èšåˆ (Complete Stacked Aggregation)
- **è§¦å‘æ¡ä»¶**: ä»»ä½•æ—¶é—´ç‚¹å­˜åœ¨ â‰¥2 ä¸ªäº‹ä»¶
- **æ¸²æŸ“æ–¹å¼**: ç»Ÿä¸€çš„ç°è‰²èšåˆå—ï¼Œä¸ä½¿ç”¨å¹¶æ’æ˜¾ç¤º
- **æ ‡è¯†**: å³ä¸Šè§’æ˜¾ç¤º `+N` å¾½ç«  (Nä¸ºäº‹ä»¶æ€»æ•°)

---

## äºŒã€æ¸²æŸ“é€»è¾‘ä¸è§†è§‰è®¾è®¡

### 2.1 è¿ç»­æ¸²æŸ“é€»è¾‘ (Continuous Rendering)

ç³»ç»Ÿé‡‡ç”¨ **äº‹ä»¶é©±åŠ¨çš„è¿ç»­æ¸²æŸ“**ï¼š

#### æ ¸å¿ƒåŸåˆ™
- æ¯ä¸ªäº‹ä»¶æ¸²æŸ“ä¸º **ä¸€ä¸ªè¿ç»­çš„å¡ç‰‡**ï¼Œè€ŒéæŒ‰å°æ—¶åˆ†æ®µ
- ä½¿ç”¨ **ç»å¯¹å®šä½** (`position: absolute`) ç²¾ç¡®æ”¾ç½®
- **1åˆ†é’Ÿ = 1px**ï¼š`top = (hour - 8) * 60 + minutes`
- äº‹ä»¶é«˜åº¦ = æŒç»­æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼Œæ— æœ€å°é«˜åº¦é™åˆ¶

#### å®šä½è®¡ç®—ç¤ºä¾‹
```typescript
// äº‹ä»¶: 10:30 - 12:45
const startMinutes = (10 - 8) * 60 + 30 = 150px  // topä½ç½®
const endMinutes = (12 - 8) * 60 + 45 = 285px
const height = 285 - 150 = 135px
```

#### æ¸²æŸ“è§„åˆ™

**è§„åˆ™A: ç‹¬ç«‹äº‹ä»¶ (Independent)**
- **æ¡ä»¶**: ä¸å…¶ä»–äº‹ä»¶ **æ— æ—¶é—´é‡å **
- **æ¸²æŸ“**: æ­£å¸¸å¡ç‰‡ï¼ŒèƒŒæ™¯è‰²ä¸ºä¼˜å…ˆçº§é¢œè‰²
- **æ˜¾ç¤ºå†…å®¹**: ä»…æ˜¾ç¤ºä»»åŠ¡æ ‡é¢˜
- **è¯¦æƒ…å±•ç¤º**: Hoveræ—¶å³ä¾§å¼¹å‡ºPopoverï¼Œæ˜¾ç¤ºæ—¶é—´ã€é¡¹ç›®ã€ä¼˜å…ˆçº§
- **æ•°æ®ç»“æ„**: `TaskRenderItem { task, top, height, renderStartTime, renderEndTime }`

**è§„åˆ™B: é‡å äº‹ä»¶ (Overlapping)**
- **æ¡ä»¶**: ä¸å…¶ä»–äº‹ä»¶ **å­˜åœ¨æ—¶é—´é‡å **
- **æ¸²æŸ“**: ç»Ÿä¸€çš„ç°è‰²èšåˆå— (#e5e7eb)
- **æ˜¾ç¤ºå†…å®¹**: æ‰€æœ‰ä»»åŠ¡æ ‡é¢˜ï¼ˆç”¨"ã€"åˆ†éš”ï¼Œå°å­—ä½“10pxï¼‰
- **å¾½ç« **: å³ä¸Šè§’æ˜¾ç¤º `+N` (Nä¸ºé‡å äº‹ä»¶æ€»æ•°)
- **æ•°æ®ç»“æ„**: `AggregationRenderItem { id, top, height, tasks[], highestPriorityTask }`

### 2.2 é‡å æ£€æµ‹ç®—æ³• (Overlap Detection)

ä½¿ç”¨ **æ‰«æçº¿ç®—æ³• (Sweep Line Algorithm)** æ£€æµ‹é‡å ï¼š

```typescript
function detectOverlaps(items: TaskRenderItem[]) {
  // 1. æŒ‰å¼€å§‹æ—¶é—´æ’åº
  // 2. éå†æ¯ä¸ªäº‹ä»¶
  // 3. æŸ¥æ‰¾ä¸å½“å‰ç»„ä»»ä½•äº‹ä»¶é‡å çš„äº‹ä»¶
  // 4. å¦‚æœé‡å ï¼ŒåŠ å…¥å½“å‰ç»„
  // 5. å•ç‹¬çš„äº‹ä»¶ â†’ independentItems
  // 6. å¤šä¸ªäº‹ä»¶çš„ç»„ â†’ overlappingGroups

  return { independentItems, overlappingGroups }
}

// é‡å åˆ¤æ–­é€»è¾‘
const overlaps = !(itemA.top >= itemB.top + itemB.height ||
                   itemA.top + itemA.height <= itemB.top)
```

### 2.3 èšåˆå—æ˜¾ç¤ºç­–ç•¥

**æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¼˜å…ˆåŸåˆ™**ï¼š
1. ä»é‡å ä»»åŠ¡ç»„ä¸­é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡
2. åœ¨ç°è‰²èšåˆå—ä¸­æ˜¾ç¤ºè¯¥ä»»åŠ¡çš„ä¿¡æ¯ï¼š
   - æ—¶é—´èŒƒå›´ï¼ˆå¦‚ "14:00-15:30"ï¼‰
   - ä»»åŠ¡æ ‡é¢˜
   - æ‰€å±é¡¹ç›®ï¼ˆå¸¦é¢œè‰²ç‚¹ï¼‰
3. å³ä¸Šè§’ `+N` å¾½ç« æ˜¾ç¤ºæ€»ä»»åŠ¡æ•°
4. Hover å¾½ç« å¼¹å‡º Popover åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡

---

## ä¸‰ã€å…¨å¤©äº‹ä»¶ (All-Day Events)

### 3.1 åˆ¤æ–­é€»è¾‘

**å®šä¹‰**: å¯¹äºç‰¹å®šæ—¥æœŸï¼Œå¦‚æœäº‹ä»¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œåˆ™è§†ä¸ºå…¨å¤©äº‹ä»¶ï¼š

```
å¼€å§‹æ—¶é—´ <= 8:00 AND ç»“æŸæ—¶é—´ >= 21:00
```

**é‡è¦**:
- æ¯å¤©å•ç‹¬è®¡ç®—
- è·¨å¤©äº‹ä»¶åœ¨ä¸åŒæ—¥æœŸå¯èƒ½æœ‰ä¸åŒçš„åˆ¤æ–­ç»“æœ

### 3.2 æ¸²æŸ“ä½ç½®

- **ä½ç½®**: 8:00åˆ»åº¦çº¿ä¸Šæ–¹çš„ç‹¬ç«‹æ°´å¹³åŒºåŸŸ
- **é«˜åº¦**: 20px (å›ºå®šé«˜åº¦)

### 3.3 æ¸²æŸ“é€»è¾‘

#### å•ä¸ªå…¨å¤©ä»»åŠ¡
- **ç»„ä»¶**: AllDayTaskCard.vue
- **æ ·å¼**: è¯ä¸¸å½¢çŠ¶ï¼Œä¼˜å…ˆçº§èƒŒæ™¯è‰²ï¼Œç™½è‰²æ–‡å­—
- **æ˜¾ç¤ºå†…å®¹**: ä»…ä»»åŠ¡æ ‡é¢˜
- **äº¤äº’**: Hoveræ—¶åº•éƒ¨å¼¹å‡ºPopoverï¼Œæ˜¾ç¤ºå®Œæ•´è¯¦æƒ…(æ ‡é¢˜ã€å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€ä¼˜å…ˆçº§ã€é¡¹ç›®)

#### å¤šä¸ªå…¨å¤©ä»»åŠ¡ (â‰¥2ä¸ª)
- **ç»„ä»¶**: AllDayAggregation.vue
- **æ ·å¼**: ç°è‰²èƒŒæ™¯ (#e5e7eb)ï¼Œç±»ä¼¼é‡å ä»»åŠ¡çš„èšåˆå—
- **æ˜¾ç¤ºå†…å®¹**: æ‰€æœ‰ä»»åŠ¡æ ‡é¢˜(ç”¨"ã€"åˆ†éš”)
- **å¾½ç« **: å³ä¾§æ˜¾ç¤º `+N` (Nä¸ºå…¨å¤©ä»»åŠ¡æ€»æ•°)
- **äº¤äº’**: Hoverå¾½ç« å¼¹å‡ºPopoverï¼Œåˆ—å‡ºæ‰€æœ‰å…¨å¤©ä»»åŠ¡(æŒ‰ä¼˜å…ˆçº§æ’åº)

### 3.4 åœºæ™¯ç¤ºä¾‹

| åœºæ™¯ | äº‹ä»¶æ—¶é—´ | ä»Šå¤©åˆ¤æ–­ | æ˜å¤©åˆ¤æ–­ |
|------|---------|---------|---------|
| A | 7:00 - 22:00 | å…¨å¤©äº‹ä»¶ | - |
| B | ä»Šå¤© 8:00 - æ˜å¤© 21:00 | å…¨å¤©äº‹ä»¶ | å…¨å¤©äº‹ä»¶ |
| C | ä»Šå¤© 10:00 - æ˜å¤© 15:00 | æ™®é€šäº‹ä»¶ (10:00-21:00) | æ™®é€šäº‹ä»¶ (8:00-15:00) |

---

## å››ã€æˆªæ–­æ•ˆæœ (Truncation)

### 4.1 è§¦å‘æ¡ä»¶

- **é¡¶éƒ¨æˆªæ–­**: äº‹ä»¶å¼€å§‹æ—¶é—´ < 8:00
- **åº•éƒ¨æˆªæ–­**: äº‹ä»¶ç»“æŸæ—¶é—´ > 21:00

### 4.2 è§†è§‰å…ƒç´ 

#### é”¯é½¿çŠ¶è¾¹ç¼˜
- **å®ç°**: CSS linear-gradient æ¨¡æ‹Ÿé”¯é½¿
- **ä½ç½®**: é¡¶éƒ¨/åº•éƒ¨è¾¹ç¼˜
- **å¤§å°**: 10pxå®½ Ã— 4pxé«˜ (å•ä¸ªé”¯é½¿)

#### æ—¶é—´æ ‡ç­¾ + ç®­å¤´
- **å…ƒç´ **: Element Plus å›¾æ ‡ (ArrowUp / ArrowDown)
- **ä½ç½®**: é”¯é½¿æ—è¾¹ï¼Œå¡ç‰‡å†…éƒ¨
- **å†…å®¹**: æ˜¾ç¤ºå®é™…å¼€å§‹/ç»“æŸæ—¶é—´ (å¦‚ "7:00", "22:30")
- **å­—ä½“**: 10px, å­—ä½“ç²—ç»† 600, ç™½è‰²

### 4.3 å®ç°ç¤ºä¾‹

```vue
<!-- é¡¶éƒ¨æˆªæ–­ -->
<div v-if="isTruncatedTop" class="truncation-indicator truncation-top">
  <el-icon><ArrowUp /></el-icon>
  <span>07:00</span>
</div>

<!-- åº•éƒ¨æˆªæ–­ -->
<div v-if="isTruncatedBottom" class="truncation-indicator truncation-bottom">
  <span>22:30</span>
  <el-icon><ArrowDown /></el-icon>
</div>
```

---

## äº”ã€äº¤äº’æ¨¡å‹

### 5.1 èšåˆå—äº¤äº’

#### Popover è§¦å‘
- **è§¦å‘æ–¹å¼**: Hover (é¼ æ ‡æ‚¬åœ)
- **è§¦å‘åŒºåŸŸ**: å³ä¸Šè§’ `+N` å¾½ç« 
- **å¼¹å‡ºä½ç½®**: èšåˆå—å³ä¾§ (placement="right")
- **å®½åº¦**: 300px

#### Popover å†…å®¹
1. **æ ‡é¢˜**: "è¯¥æ—¶é—´æ®µçš„ä»»åŠ¡ (N)"
2. **åˆ—è¡¨**: æŒ‰ **ä¼˜å…ˆçº§é™åº** æ’åˆ—ï¼ŒåŒä¼˜å…ˆçº§æŒ‰å¼€å§‹æ—¶é—´å‡åº
3. **æ¯é¡¹æ˜¾ç¤º**:
   - ä¼˜å…ˆçº§é¢œè‰²æ¡ (å·¦ä¾§ 3px border)
   - æ—¶é—´èŒƒå›´ (å¦‚ "14:00-15:30")
   - ä»»åŠ¡æ ‡é¢˜
   - æ‰€å±é¡¹ç›® (å¦‚æœ‰)

4. **ç‚¹å‡»äº‹ä»¶**: åˆ—è¡¨é¡¹å¯ç‚¹å‡»ï¼Œè§¦å‘ `task-click` äº‹ä»¶

### 5.2 ä»»åŠ¡å¡ç‰‡äº¤äº’

- **ç‚¹å‡»**: è§¦å‘ `task-click` äº‹ä»¶ï¼Œæ‰“å¼€ä»»åŠ¡è¯¦æƒ…
- **Hover**: è½»å¾®ä¸Šç§» + é˜´å½±åŠ æ·±

### 5.3 å…¨å¤©ä»»åŠ¡äº¤äº’

#### AllDayTaskCard (å•ä»»åŠ¡)
- **Hover**: Popoveræ˜¾ç¤ºå®Œæ•´ä»»åŠ¡è¯¦æƒ…
- **ç‚¹å‡»**: è§¦å‘ `task-click` äº‹ä»¶

#### AllDayAggregation (å¤šä»»åŠ¡)
- **Hoverå¾½ç« **: Popoveråˆ—å‡ºæ‰€æœ‰å…¨å¤©ä»»åŠ¡
- **ç‚¹å‡»ä»»åŠ¡**: åˆ—è¡¨ä¸­æ¯ä¸ªä»»åŠ¡å¯ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…

---

## å…­ã€æŠ€æœ¯å®ç°è¦ç‚¹

### 6.1 ç»„ä»¶ç»“æ„

```
WeekSchedule.vue (ä¸»å®¹å™¨)
â”œâ”€â”€ å…¨å¤©äº‹ä»¶åŒº
â”‚   â”œâ”€â”€ AllDayTaskCard.vue (å•ä¸ªå…¨å¤©ä»»åŠ¡ - å¸¦Popoverè¯¦æƒ…)
â”‚   â””â”€â”€ AllDayAggregation.vue (å¤šä¸ªå…¨å¤©ä»»åŠ¡èšåˆ - ç°è‰²èƒŒæ™¯+å¾½ç« )
â”œâ”€â”€ æ—¶é—´è½´åŒº
â”‚   â”œâ”€â”€ TaskCard.vue (å•ä»»åŠ¡å¡ç‰‡ - ç‹¬ç«‹äº‹ä»¶)
â”‚   â””â”€â”€ AggregationBlock.vue (èšåˆå— + Popover - é‡å äº‹ä»¶)
```

**ç§»é™¤ç»„ä»¶**:
- `ConnectorLine.vue` - è¿ç»­æ¸²æŸ“ä¸éœ€è¦è¿æ¥çº¿

### 6.2 æ ¸å¿ƒå‡½æ•°

#### `isAllDayEvent(task, date): boolean`
åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ä¸ºæŒ‡å®šæ—¥æœŸçš„å…¨å¤©äº‹ä»¶

#### `calculateRenderItems(tasks, date): { taskItems, aggregationItems }`
è®¡ç®—æ¸²æŸ“é¡¹ï¼Œè¿”å›ç‹¬ç«‹ä»»åŠ¡åˆ—è¡¨å’Œèšåˆå—åˆ—è¡¨
- å°†ä»»åŠ¡è½¬æ¢ä¸º `TaskRenderItem` (å¸¦ç²¾ç¡®çš„ top/height)
- è°ƒç”¨ `detectOverlaps()` æ£€æµ‹é‡å 
- ä¸ºé‡å ç»„åˆ›å»º `AggregationRenderItem`

#### `detectOverlaps(items): { independentItems, overlappingGroups }`
ä½¿ç”¨æ‰«æçº¿ç®—æ³•æ£€æµ‹æ—¶é—´é‡å 
- éå†æ‰€æœ‰ä»»åŠ¡é¡¹
- æ£€æµ‹æ—¶é—´æ®µé‡å 
- åˆ†ç»„é‡å ä»»åŠ¡
- è¿”å›ç‹¬ç«‹ä»»åŠ¡å’Œé‡å ç»„

### 6.3 æ•°æ®æµ

```
props.tasks
  â†“
åˆ†ç±»: getAllDayTasks / getRegularTasks
  â†“
è¿ç»­æ¸²æŸ“è®¡ç®—: calculateRenderItems
  â”œâ”€ è½¬æ¢ä¸º TaskRenderItem (top, height, renderStartTime, renderEndTime)
  â””â”€ é‡å æ£€æµ‹: detectOverlaps
       â”œâ”€ independentItems â†’ TaskCard ç»„ä»¶
       â””â”€ overlappingGroups â†’ AggregationBlock ç»„ä»¶
  â†“
æ¸²æŸ“: TaskCard (ç‹¬ç«‹) / AggregationBlock (é‡å )
```

### 6.4 æ•°æ®ç»“æ„å®šä¹‰

```typescript
interface TaskRenderItem {
  task: Task
  top: number            // px offset from 8:00
  height: number         // px (minimum 10px)
  renderStartTime: Date  // actual render start (clamped to viewport)
  renderEndTime: Date    // actual render end (clamped to viewport)
}

interface AggregationRenderItem {
  id: string             // Unique identifier
  top: number            // Aggregation block top position
  height: number         // Aggregation block height
  tasks: Task[]          // All overlapping tasks
  highestPriorityTask: Task  // Task with highest priority
}
```

---

## ä¸ƒã€æ ·å¼è§„èŒƒ

### 7.1 è‰²å½©å˜é‡

```scss
$color-priority-high: #ef4444;    // çº¢è‰² (4-5)
$color-priority-medium: #3b82f6;  // è“è‰² (2-3)
$color-priority-low: #10b981;     // ç»¿è‰² (0-1)
$color-aggregation: #e5e7eb;      // èšåˆç°
```

### 7.2 å°ºå¯¸è§„èŒƒ

- æ—¶é—´æ ¼: 60px (1å°æ—¶)
- å®šä½ç²¾åº¦: 1px (1åˆ†é’Ÿ)
- å…¨å¤©äº‹ä»¶åŒº: é«˜åº¦ 20px
- å¡ç‰‡å†…è¾¹è·: 4px 8px
- äº‹ä»¶æ¸²æŸ“é«˜åº¦: å®Œå…¨æŒ‰ç…§å®é™…æ—¶é•¿è®¡ç®—ï¼ˆ1åˆ†é’Ÿ = 1pxï¼‰ï¼Œæ— æœ€å°é«˜åº¦é™åˆ¶
- æ ‡é¢˜æ˜¾ç¤ºé˜ˆå€¼: é«˜åº¦ < 15px æ—¶éšè—æ ‡é¢˜ï¼Œé€šè¿‡ Popover æŸ¥çœ‹è¯¦æƒ…
- èšåˆå¾½ç« : 2px 6px, å­—ä½“ 10px
- æ—¥ç¨‹è¡¨æ€»é«˜åº¦: 780px (13å°æ—¶ Ã— 60px)

### 7.3 å­—ä½“è§„èŒƒ

- è¶…å°å­—: 10px (å…¨å¤©äº‹ä»¶ã€å¾½ç« )
- å°å­—: 12px (æ—¶é—´ã€ä»»åŠ¡æ ‡é¢˜)
- ä¸­å­—: 14px (Popoveræ ‡é¢˜)

---

## å…«ã€è¾¹ç•Œæƒ…å†µå¤„ç†

### 8.1 è·¨å¤©äº‹ä»¶

**å¤„ç†åŸåˆ™**: æ¯å¤©ç‹¬ç«‹æ¸²æŸ“äº‹ä»¶åœ¨è¯¥å¤©çš„ç‰‡æ®µ

**ç¤ºä¾‹**: äº‹ä»¶ä»ä»Šå¤© 20:00 åˆ°æ˜å¤© 10:00

- **ä»Šå¤©**:
  - 20:00-21:00 æ˜¾ç¤ºå¡ç‰‡
  - åº•éƒ¨æˆªæ–­ (ç®­å¤´ + "æ˜å¤© 10:00")
- **æ˜å¤©**:
  - è‹¥æ»¡è¶³å…¨å¤©æ¡ä»¶ â†’ å…¨å¤©äº‹ä»¶åŒº
  - å¦åˆ™ 8:00-10:00 æ˜¾ç¤ºå¡ç‰‡ï¼Œé¡¶éƒ¨æˆªæ–­

### 8.2 æ— æ—¶é—´ä»»åŠ¡ (æµ®åŠ¨ä»»åŠ¡)

#### 8.2.1 åŸºæœ¬æ¦‚å¿µ

**å®šä¹‰**: æ²¡æœ‰æŒ‡å®š `start_time` å’Œ `end_time` çš„ä»»åŠ¡,ç§°ä¸ºæµ®åŠ¨ä»»åŠ¡æˆ–å¾…åŠä»»åŠ¡ã€‚

**åˆ›å»ºæ–¹å¼**:
- åœ¨ä»»åŠ¡åˆ›å»ºè¡¨å•ä¸­,å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´å­—æ®µå‡ä¸ºå¯é€‰
- ç•™ç©ºæ—¶é—´å­—æ®µåˆ™åˆ›å»ºä¸ºæµ®åŠ¨ä»»åŠ¡

#### 8.2.2 æ˜¾ç¤ºåŒºåŸŸ

**ä½ç½®**: æ—¥ç¨‹è¡¨ä¸‹æ–¹çš„ç‹¬ç«‹åŒºåŸŸ,å§‹ç»ˆå¯è§

**å¸ƒå±€ç»“æ„**:
```
ğŸ“‹ æ— æ—¶é—´ä»»åŠ¡(æ‹–æ‹½åˆ°æ—¥ç¨‹è¡¨å¯æŒ‡å®šæ—¶é—´)    [2]  â† ä»»åŠ¡è®¡æ•°å¾½ç« 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜ ä»»åŠ¡æ ‡é¢˜                         â”‚
â”‚   [å»¶åæŒ‰é’®]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜ å¦ä¸€ä¸ªä»»åŠ¡                       â”‚
â”‚   [å»¶åæŒ‰é’®]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç©ºçŠ¶æ€** (æ— ä»»åŠ¡æ—¶):
```
ğŸ“‹ æ— æ—¶é—´ä»»åŠ¡(æ‹–æ‹½åˆ°æ—¥ç¨‹è¡¨å¯æŒ‡å®šæ—¶é—´)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ğŸ“… (æ—¥å†å›¾æ ‡)              â”‚
â”‚       æš‚æ— å¾…åŠä»»åŠ¡                  â”‚
â”‚ å°†æ—¥ç¨‹è¡¨ä¸Šçš„ä»»åŠ¡æ‹–åˆ°è¿™é‡Œå¯æ ‡è®°ä¸º     â”‚
â”‚       "ç¨åå®‰æ’"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.2.3 æ‹–æ‹½åŠŸèƒ½

##### A. æµ®åŠ¨ä»»åŠ¡ â†’ æ—¥ç¨‹è¡¨ (æ·»åŠ æ—¶é—´)

**æ“ä½œæµç¨‹**:
1. ç”¨æˆ·ä»æµ®åŠ¨åŒºåŸŸæ‹–æ‹½ä»»åŠ¡
2. æ‹–æ‹½è¿‡ç¨‹ä¸­æ˜¾ç¤ºåŠé€æ˜é¢„è§ˆå—(è“è‰²è™šçº¿è¾¹æ¡†)
3. é¢„è§ˆå—è‡ªåŠ¨å¯¹é½åˆ°15åˆ†é’Ÿåˆ»åº¦
4. é‡Šæ”¾é¼ æ ‡,ä»»åŠ¡è‡ªåŠ¨æ·»åŠ æ—¶é—´

**æ—¶é—´è®¡ç®—é€»è¾‘**:
```typescript
// 1. æ ¹æ®æ‹–æ‹½é‡Šæ”¾ä½ç½®è®¡ç®—å¼€å§‹æ—¶é—´(15åˆ†é’Ÿå¯¹é½)
const minutesFromStart = Math.floor(offsetY / MINUTES_PER_PIXEL)
const snappedMinutes = Math.floor(minutesFromStart / 15) * 15
const hour = SCHEDULE_START_HOUR + Math.floor(snappedMinutes / 60)
const minute = snappedMinutes % 60

// 2. å¼€å§‹æ—¶é—´ = æ‹–æ‹½æ—¥æœŸ + è®¡ç®—çš„æ—¶åˆ†
const startTime = new Date(year, month, day, hour, minute, 0, 0)

// 3. ç»“æŸæ—¶é—´ = å¼€å§‹æ—¶é—´ + 1å°æ—¶(é»˜è®¤)
const endTime = new Date(startTime)
endTime.setHours(endTime.getHours() + 1)
```

**æ•°æ®æ›´æ–°**:
```typescript
await taskStore.updateTask(taskId, {
  start_time: startTime.toISOString(),
  end_time: endTime.toISOString(),
  snooze_until: null  // æ¸…é™¤å»¶åçŠ¶æ€
})
```

**ç”¨æˆ·åé¦ˆ**:
- æˆåŠŸæç¤º: "ä»»åŠ¡å·²å®‰æ’åˆ° 2025å¹´11æœˆ10æ—¥ 14:30"

##### B. æ—¥ç¨‹è¡¨ â†’ æµ®åŠ¨åŒºåŸŸ (ç§»é™¤æ—¶é—´)

**æ“ä½œæµç¨‹**:
1. ç”¨æˆ·ä»æ—¥ç¨‹è¡¨æ‹–æ‹½å·²å®‰æ’çš„ä»»åŠ¡
2. æ‹–æ‹½åˆ°æµ®åŠ¨åŒºåŸŸä¸Šæ–¹æ—¶,åŒºåŸŸé«˜äº®æ˜¾ç¤º(è“è‰²è¾¹æ¡†+æµ…è“èƒŒæ™¯+é˜´å½±)
3. é‡Šæ”¾é¼ æ ‡,ä»»åŠ¡æ—¶é—´è¢«ç§»é™¤

**æ‹–æ‹½é«˜äº®æ•ˆæœ**:
```scss
.floating-tasks {
  border: 2px dashed $color-border;
  transition: all 0.15s ease;

  &.is-drag-over {
    border-color: $color-primary;        // è“è‰²è¾¹æ¡†
    background-color: rgba($color-primary, 0.05);  // 5%é€æ˜åº¦èƒŒæ™¯
    box-shadow: 0 0 0 4px rgba($color-primary, 0.1);  // å¤–é˜´å½±
  }
}
```

**æ•°æ®æ›´æ–°**:
```typescript
await taskStore.updateTask(taskId, {
  start_time: null,
  end_time: null
})
```

**ç”¨æˆ·åé¦ˆ**:
- æˆåŠŸæç¤º: "ä»»åŠ¡å·²ç§»è‡³å¾…åŠåˆ—è¡¨"

#### 8.2.4 è§†è§‰åé¦ˆè®¾è®¡

**æ‹–æ‹½é¢„è§ˆ**:
- é€æ˜çš„æ‹–æ‹½é•œåƒ(é¿å…æµè§ˆå™¨é»˜è®¤çš„é¬¼å½±å›¾åƒ)
- åŠé€æ˜è“è‰²é¢„è§ˆæ¡†æ˜¾ç¤ºé‡Šæ”¾ä½ç½®
- 15åˆ†é’Ÿç²¾åº¦çš„è‡ªåŠ¨å¯¹é½

**æ‹–æ‹½çŠ¶æ€**:
- ä»»åŠ¡å¡ç‰‡: `cursor: move` (ç§»åŠ¨å…‰æ ‡)
- æ‹–æ‹½ä¸­: åŸä½ç½®ä¿æŒå¯è§,åŠé€æ˜
- æ‹–æ‹½ç»“æŸ: å¹³æ»‘è¿‡æ¸¡åˆ°æ–°ä½ç½®

**åŒºåŸŸåé¦ˆ**:
| çŠ¶æ€ | è¾¹æ¡† | èƒŒæ™¯ | é˜´å½± |
|------|------|------|------|
| æ­£å¸¸ | ç°è‰²è™šçº¿ | æµ…ç°è‰² | æ—  |
| Hover | ç°è‰²è™šçº¿ | æµ…ç°è‰² | æ—  |
| æ‹–æ‹½ç»è¿‡ | è“è‰²è™šçº¿ | æµ…è“è‰²(5%) | è“è‰²å¤–é˜´å½± |

#### 8.2.5 å®ç°è¦ç‚¹

**å…³é”®ç»„ä»¶**:
- `WeekSchedule.vue`: ä¸»å®¹å™¨,å¤„ç†æ‹–æ‹½äº‹ä»¶
- `TaskCard.vue`: æ—¥ç¨‹ä»»åŠ¡å¡ç‰‡,è®¾ç½® `draggable="true"`
- `DashboardView.vue`: å¤„ç†æ‹–æ‹½é€»è¾‘å’ŒAPIè°ƒç”¨

**äº‹ä»¶å¤„ç†**:
```typescript
// WeekSchedule.vue
function handleFloatingAreaDragOver(event: DragEvent) {
  event.preventDefault()
  isDragOverFloatingArea.value = true
}

function handleFloatingAreaDrop(event: DragEvent) {
  event.preventDefault()
  isDragOverFloatingArea.value = false
  const taskId = event.dataTransfer?.getData('taskId')
  // å‘é€ç‰¹æ®Šä¿¡å·: hour === -1 è¡¨ç¤ºç§»é™¤æ—¶é—´
  emit('task-drop', taskId, null, -1, -1)
}

// DashboardView.vue
async function handleTaskDrop(taskId, date, hour, minute) {
  if (hour === -1 || date === null) {
    // ç§»é™¤æ—¶é—´ â†’ æµ®åŠ¨ä»»åŠ¡
    await taskStore.updateTask(Number(taskId), {
      start_time: null,
      end_time: null
    })
  } else {
    // æ·»åŠ æ—¶é—´ â†’ æ—¥ç¨‹ä»»åŠ¡
    const startTime = new Date(...)
    const endTime = new Date(startTime)
    endTime.setHours(endTime.getHours() + 1)
    await taskStore.updateTask(Number(taskId), {
      start_time: startTime.toISOString(),
      end_time: endTime.toISOString()
    })
  }
}
```

**æ‹–æ‹½ç²¾åº¦**:
- æ—¶é—´å¯¹é½: 15åˆ†é’Ÿåˆ»åº¦ (æ¯”æ•´ç‚¹æ›´çµæ´»,æ¯”1åˆ†é’Ÿæ›´æ¸…æ™°)
- è®¡ç®—å…¬å¼: `snappedMinutes = Math.floor(minutesFromStart / 15) * 15`

### 8.3 å·²å®Œæˆä»»åŠ¡

- **æ˜¾ç¤º**: ä¿ç•™åœ¨æ—¥ç¨‹è¡¨ä¸­
- **æ ·å¼**: é€æ˜åº¦ 60%, åˆ é™¤çº¿

---

## ä¹ã€æ€§èƒ½ä¼˜åŒ–

### 9.1 è®¡ç®—ç¼“å­˜

- ä½¿ç”¨ Vue çš„ `computed` ç¼“å­˜ç‰‡æ®µè®¡ç®—ç»“æœ
- ä»…åœ¨ `tasks` æˆ– `currentWeekStart` å˜åŒ–æ—¶é‡æ–°è®¡ç®—

### 9.2 æ¸²æŸ“ä¼˜åŒ–

- ä½¿ç”¨ `v-if` é¿å…æ¸²æŸ“ç©ºæ—¶é—´æ ¼
- Popover æ‡’åŠ è½½å†…å®¹

---

## åã€æµ‹è¯•ç”¨ä¾‹

### 10.1 å…¨å¤©äº‹ä»¶åˆ¤æ–­

```typescript
// ç”¨ä¾‹1: æ ‡å‡†å…¨å¤©äº‹ä»¶
task = { startTime: '2025-11-04 07:00', endTime: '2025-11-04 22:00' }
date = 2025-11-04
æœŸæœ›: isAllDayEvent(task, date) === true

// ç”¨ä¾‹2: éå…¨å¤©äº‹ä»¶
task = { startTime: '2025-11-04 10:00', endTime: '2025-11-04 15:00' }
æœŸæœ›: isAllDayEvent(task, date) === false

// ç”¨ä¾‹3: è·¨å¤©å…¨å¤©äº‹ä»¶
task = { startTime: '2025-11-04 08:00', endTime: '2025-11-05 21:00' }
æœŸæœ›: isAllDayEvent(task, '2025-11-04') === true
      isAllDayEvent(task, '2025-11-05') === true
```

### 10.2 é‡å æ£€æµ‹è®¡ç®—

```typescript
// åœºæ™¯: ä¸¤ä¸ªé‡å ä»»åŠ¡
taskA = { start: '10:00', end: '12:00', priority: 5 }
taskB = { start: '11:00', end: '13:00', priority: 2 }

// è½¬æ¢ä¸º TaskRenderItem
itemA = { task: taskA, top: 120, height: 120, ... }  // (10-8)*60=120, 2å°æ—¶=120px
itemB = { task: taskB, top: 180, height: 120, ... }  // (11-8)*60=180, 2å°æ—¶=120px

// é‡å æ£€æµ‹
overlaps = !(itemA.top >= itemB.top + itemB.height ||
             itemA.top + itemA.height <= itemB.top)
         = !(120 >= 300 || 240 <= 180)
         = true

æœŸæœ›ç»“æœ:
{
  independentItems: [],
  overlappingGroups: [
    [itemA, itemB]  // è¿™ä¸¤ä¸ªä»»åŠ¡é‡å ï¼Œåˆ›å»ºèšåˆå—
  ]
}

// èšåˆå—è®¡ç®—
aggregationBlock = {
  id: 'agg-2025-11-04-0',
  top: 120,           // min(120, 180)
  height: 180,        // max(240, 300) - min(120, 180)
  tasks: [taskA, taskB],
  highestPriorityTask: taskA  // priority 5 > 2
}
```

### 10.3 åˆ†é’Ÿç²¾åº¦è®¡ç®—

```typescript
// åœºæ™¯: 10:23 - 12:47 çš„ä»»åŠ¡
const startMinutes = (10 - 8) * 60 + 23 = 143px
const endMinutes = (12 - 8) * 60 + 47 = 287px
const height = 287 - 143 = 144px

æœŸæœ› TaskRenderItem:
{
  task: {...},
  top: 143,
  height: 144,
  renderStartTime: new Date('2025-11-04 10:23'),
  renderEndTime: new Date('2025-11-04 12:47')
}
```

---

## åä¸€ã€æœªæ¥æ‰©å±•

### 11.1 æ€§èƒ½å¢å¼º

- è™šæ‹Ÿæ»šåŠ¨ (å¤§é‡äº‹ä»¶æ—¶)
- Web Worker è®¡ç®—åˆ†ç‰‡

### 11.2 åŠŸèƒ½å¢å¼º

- æ‹–æ‹½è°ƒæ•´äº‹ä»¶æ—¶é—´
- å³é”®èœå•å¿«é€Ÿæ“ä½œ
- æ—¶é—´æ ¼ç¼©æ”¾ (15åˆ†é’Ÿ/30åˆ†é’Ÿ)

### 11.3 è§†è§‰å¢å¼º

- æ·±è‰²æ¨¡å¼é€‚é…
- è‡ªå®šä¹‰é…è‰²æ–¹æ¡ˆ
- åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ

---

## åäºŒã€å‚è€ƒèµ„æ–™

- Element Plus Popover: https://element-plus.org/zh-CN/component/popover.html
- Vue 3 Composition API: https://vuejs.org/guide/extras/composition-api-faq.html
- CSS Grid Layout: https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Grid_Layout

---

**æ–‡æ¡£ç‰ˆæœ¬**: 3.1
**åˆ›å»ºæ—¥æœŸ**: 2025-11-04
**æœ€åæ›´æ–°**: 2025-11-10
**æ›´æ–°è¯´æ˜**:
- v2.0: ä»åˆ†ç‰‡å¼æ¸²æŸ“å‡çº§ä¸ºè¿ç»­æ¸²æŸ“ï¼Œç§»é™¤è¿æ¥çº¿ç»„ä»¶ï¼Œæ·»åŠ æ‰«æçº¿ç®—æ³•å’Œåˆ†é’Ÿçº§ç²¾åº¦
- v2.1: ä¼˜åŒ–æ˜¾ç¤ºç»†èŠ‚ - è°ƒæ•´å°ºå¯¸è§„èŒƒ(å…¨å¤©äº‹ä»¶20pxã€æœ€å°äº‹ä»¶é«˜åº¦15px)ã€ç®€åŒ–TaskCardæ˜¾ç¤º(åªæ˜¾ç¤ºæ ‡é¢˜+Popoverè¯¦æƒ…)ã€ä¼˜åŒ–AggregationBlockæ˜¾ç¤º(æ‰€æœ‰ä»»åŠ¡æ ‡é¢˜)ã€æ—¶é—´æ ¼å¼ä¼˜åŒ–(å®Œæ•´æ—¥æœŸæ—¶é—´)
- v3.0: æ–°å¢å…¨å¤©ä»»åŠ¡ç»„ä»¶ - å•ä»»åŠ¡ä½¿ç”¨AllDayTaskCardå¸¦Popoverè¯¦æƒ…ï¼Œå¤šä»»åŠ¡ä½¿ç”¨AllDayAggregationèšåˆæ˜¾ç¤º(ç°è‰²èƒŒæ™¯+å¾½ç« )ï¼Œå®Œå–„å…¨å¤©ä»»åŠ¡äº¤äº’ä½“éªŒ
- v3.1: æ–°å¢æµ®åŠ¨ä»»åŠ¡åŠŸèƒ½ - æ”¯æŒåˆ›å»ºæ— æ—¶é—´ä»»åŠ¡ã€æµ®åŠ¨ä»»åŠ¡åŒºåŸŸå§‹ç»ˆå¯è§(å«ç©ºçŠ¶æ€)ã€åŒå‘æ‹–æ‹½åŠŸèƒ½(æµ®åŠ¨â†”æ—¥ç¨‹)ã€15åˆ†é’Ÿç²¾åº¦æ—¶é—´å¯¹é½ã€æ‹–æ‹½è§†è§‰åé¦ˆ(é«˜äº®+é¢„è§ˆ)ã€é»˜è®¤1å°æ—¶ä»»åŠ¡æ—¶é•¿
