# 日程表详细设计文档

## 核心设计理念

**基于优先级的颜色系统 + 连续渲染 + 完全堆叠聚合**

通过精确的分钟级定位和重叠检测算法，实现清晰、直观的日程管理界面。

> **重要更新 (2025-11-13)**:
> - ✅ 已移除所有拖拽功能 - 任务时间调整现通过编辑对话框完成
> - ✅ 术语变更: "未安排任务" → "无安排任务" (未指定时间的任务)
> - ✅ 术语变更: "无时间任务" → "无安排任务"
> - ✅ "延后任务"仅指被snooze的任务

---

## 一、核心原则与布局

### 1.1 视图窗口 (Viewport)

- **时间范围**: 8:00 - 21:00 (13小时)
- **超出处理**: 早于8:00或晚于21:00的活动通过截断效果渲染

### 1.2 网格系统 (Grid System)

- **垂直时间轴**: 每格代表 **1小时** (60px)，但事件定位精度为 **1分钟** (1px)
- **布局**: 左侧时间列 + 7个工作日列
- **定位机制**: 事件使用绝对定位，基于分钟级精度计算 `top` 和 `height`

### 1.3 颜色系统 (Color System)

**任务卡片颜色 = 项目颜色 × 优先级透明度**

| 颜色来源 | 计算方式 | 说明 |
|---------|---------|------|
| 背景色 | 任务所属项目的颜色 | 默认紫色 #667eea (无项目时) |
| 透明度 | `0.25 + (priority × 0.15)` | 优先级0=25%，优先级5=100% |
| 重叠聚合块 | - | 黑色 #2d3748 (白色文字) |

**透明度映射表**:

| 优先级 | 透明度 | 视觉效果 |
|--------|--------|----------|
| 5 (最高) | 100% (1.0) | 完全不透明，颜色最鲜艳 |
| 4 | 85% (0.85) | 高亮显示 |
| 3 | 70% (0.70) | 中等醒目 |
| 2 | 55% (0.55) | 较淡 |
| 1 | 40% (0.40) | 半透明 |
| 0 (最低) | 25% (0.25) | 最淡，视觉退后 |

### 1.4 重叠策略 (Overlap Strategy)

- **策略名称**: 完全堆叠聚合 (Complete Stacked Aggregation)
- **触发条件**: 任何时间点存在 ≥2 个事件
- **渲染方式**: 统一的灰色聚合块，不使用并排显示
- **标识**: 右上角显示 `+N` 徽章 (N为事件总数)

---

## 二、渲染逻辑与视觉设计

### 2.1 连续渲染逻辑 (Continuous Rendering)

系统采用 **事件驱动的连续渲染**：

#### 核心原则
- 每个事件渲染为 **一个连续的卡片**，而非按小时分段
- 使用 **绝对定位** (`position: absolute`) 精确放置
- **1分钟 = 1px**：`top = (hour - 8) * 60 + minutes`
- 事件高度 = 持续时长（分钟），无最小高度限制

#### 定位计算示例
```typescript
// 事件: 10:30 - 12:45
const startMinutes = (10 - 8) * 60 + 30 = 150px  // top位置
const endMinutes = (12 - 8) * 60 + 45 = 285px
const height = 285 - 150 = 135px
```

#### 渲染规则

**规则A: 独立事件 (Independent)**
- **条件**: 与其他事件 **无时间重叠**
- **渲染**: 正常卡片，背景色为**项目颜色**，透明度根据**优先级**计算
- **显示内容**: 仅显示任务标题
- **详情展示**: Hover时右侧弹出Popover，显示时间、项目、优先级
- **数据结构**: `TaskRenderItem { task, top, height, renderStartTime, renderEndTime }`

**规则B: 重叠事件 (Overlapping)**
- **条件**: 与其他事件 **存在时间重叠**
- **渲染**: 统一的**黑色聚合块** (#2d3748)，**白色文字**，强视觉对比
- **显示内容**: 所有任务标题（用"、"分隔，小字体10px，白色）
- **徽章**: 右上角显示 `+N` (N为重叠事件总数)
- **数据结构**: `AggregationRenderItem { id, top, height, tasks[], highestPriorityTask }`

### 2.2 重叠检测算法 (Overlap Detection)

使用 **扫描线算法 (Sweep Line Algorithm)** 检测重叠：

```typescript
function detectOverlaps(items: TaskRenderItem[]) {
  // 1. 按开始时间排序
  // 2. 遍历每个事件
  // 3. 查找与当前组任何事件重叠的事件
  // 4. 如果重叠，加入当前组
  // 5. 单独的事件 → independentItems
  // 6. 多个事件的组 → overlappingGroups

  return { independentItems, overlappingGroups }
}

// 重叠判断逻辑
const overlaps = !(itemA.top >= itemB.top + itemB.height ||
                   itemA.top + itemA.height <= itemB.top)
```

### 2.3 聚合块显示策略

**最高优先级任务优先原则**：
1. 从重叠任务组中选择优先级最高的任务
2. 在灰色聚合块中显示该任务的信息：
   - 时间范围（如 "14:00-15:30"）
   - 任务标题
   - 所属项目（带颜色点）
3. 右上角 `+N` 徽章显示总任务数
4. Hover 徽章弹出 Popover 列出所有任务

---

## 三、全天事件 (All-Day Events)

### 3.1 判断逻辑

**定义**: 对于特定日期，如果事件满足以下条件，则视为全天事件：

```
开始时间 <= 8:00 AND 结束时间 >= 21:00
```

**重要**:
- 每天单独计算
- 跨天事件在不同日期可能有不同的判断结果

### 3.2 渲染位置

- **位置**: 8:00刻度线上方的独立水平区域
- **高度**: 20px (固定高度)

### 3.3 渲染逻辑

#### 单个全天任务
- **组件**: AllDayTaskCard.vue
- **样式**: 药丸形状，**项目颜色**背景，透明度根据**优先级**计算，白色文字
- **显示内容**: 仅任务标题
- **交互**: Hover时底部弹出Popover，显示完整详情(标题、开始时间、结束时间、优先级、项目)

#### 多个全天任务 (≥2个)
- **组件**: AllDayAggregation.vue
- **样式**: **黑色背景** (#2d3748)，**白色文字**，类似重叠任务的聚合块
- **显示内容**: 所有任务标题(用"、"分隔，白色10px字体)
- **徽章**: 右侧显示 `+N` (N为全天任务总数)
- **交互**: Hover徽章弹出Popover，列出所有全天任务(按优先级排序)

### 3.4 场景示例

| 场景 | 事件时间 | 今天判断 | 明天判断 |
|------|---------|---------|---------|
| A | 7:00 - 22:00 | 全天事件 | - |
| B | 今天 8:00 - 明天 21:00 | 全天事件 | 全天事件 |
| C | 今天 10:00 - 明天 15:00 | 普通事件 (10:00-21:00) | 普通事件 (8:00-15:00) |

---

## 四、截断效果 (Truncation)

### 4.1 触发条件

- **顶部截断**: 事件开始时间 < 8:00
- **底部截断**: 事件结束时间 > 21:00

### 4.2 视觉元素

#### 锯齿状边缘
- **实现**: CSS linear-gradient 模拟锯齿
- **位置**: 顶部/底部边缘
- **大小**: 10px宽 × 4px高 (单个锯齿)

#### 时间标签 + 箭头
- **元素**: Element Plus 图标 (ArrowUp / ArrowDown)
- **位置**: 锯齿旁边，卡片内部
- **内容**: 显示实际开始/结束时间 (如 "7:00", "22:30")
- **字体**: 10px, 字体粗细 600, 白色

### 4.3 实现示例

```vue
<!-- 顶部截断 -->
<div v-if="isTruncatedTop" class="truncation-indicator truncation-top">
  <el-icon><ArrowUp /></el-icon>
  <span>07:00</span>
</div>

<!-- 底部截断 -->
<div v-if="isTruncatedBottom" class="truncation-indicator truncation-bottom">
  <span>22:30</span>
  <el-icon><ArrowDown /></el-icon>
</div>
```

---

## 五、交互模型

### 5.1 聚合块交互

#### Popover 触发
- **触发方式**: Hover (鼠标悬停)
- **触发区域**: 右上角 `+N` 徽章
- **弹出位置**: 聚合块右侧 (placement="right")
- **宽度**: 300px

#### Popover 内容
1. **标题**: "该时间段的任务 (N)"
2. **列表**: 按 **优先级降序** 排列，同优先级按开始时间升序
3. **每项显示**:
   - 优先级颜色条 (左侧 3px border)
   - 时间范围 (如 "14:00-15:30")
   - 任务标题
   - 所属项目 (如有)

4. **点击事件**: 列表项可点击，触发 `task-click` 事件

### 5.2 任务卡片交互

- **点击**: 触发 `task-click` 事件，打开任务详情
- **Hover**: 轻微上移 + 阴影加深

### 5.3 全天任务交互

#### AllDayTaskCard (单任务)
- **Hover**: Popover显示完整任务详情
- **点击**: 触发 `task-click` 事件

#### AllDayAggregation (多任务)
- **Hover徽章**: Popover列出所有全天任务
- **点击任务**: 列表中每个任务可点击查看详情

---

## 六、技术实现要点

### 6.1 组件结构

```
WeekSchedule.vue (主容器)
├── 全天事件区
│   ├── AllDayTaskCard.vue (单个全天任务 - 带Popover详情)
│   └── AllDayAggregation.vue (多个全天任务聚合 - 灰色背景+徽章)
├── 时间轴区
│   ├── TaskCard.vue (单任务卡片 - 独立事件)
│   └── AggregationBlock.vue (聚合块 + Popover - 重叠事件)
```

**移除组件**:
- `ConnectorLine.vue` - 连续渲染不需要连接线

### 6.2 核心函数

#### `isAllDayEvent(task, date): boolean`
判断任务是否为指定日期的全天事件

#### `calculateRenderItems(tasks, date): { taskItems, aggregationItems }`
计算渲染项，返回独立任务列表和聚合块列表
- 将任务转换为 `TaskRenderItem` (带精确的 top/height)
- 调用 `detectOverlaps()` 检测重叠
- 为重叠组创建 `AggregationRenderItem`

#### `detectOverlaps(items): { independentItems, overlappingGroups }`
使用扫描线算法检测时间重叠
- 遍历所有任务项
- 检测时间段重叠
- 分组重叠任务
- 返回独立任务和重叠组

### 6.3 数据流

```
props.tasks
  ↓
分类: getAllDayTasks / getRegularTasks
  ↓
连续渲染计算: calculateRenderItems
  ├─ 转换为 TaskRenderItem (top, height, renderStartTime, renderEndTime)
  └─ 重叠检测: detectOverlaps
       ├─ independentItems → TaskCard 组件
       └─ overlappingGroups → AggregationBlock 组件
  ↓
渲染: TaskCard (独立) / AggregationBlock (重叠)
```

### 6.4 数据结构定义

```typescript
interface TaskRenderItem {
  task: Task
  top: number            // px offset from 8:00
  height: number         // px (minimum 10px)
  renderStartTime: Date  // actual render start (clamped to viewport)
  renderEndTime: Date    // actual render end (clamped to viewport)
}

interface AggregationRenderItem {
  id: string             // Unique identifier
  top: number            // Aggregation block top position
  height: number         // Aggregation block height
  tasks: Task[]          // All overlapping tasks
  highestPriorityTask: Task  // Task with highest priority
}
```

---

## 七、样式规范

### 7.1 色彩变量

```scss
// 任务卡片颜色来自项目配置，透明度基于优先级
// taskBackgroundColor = task.project?.color || '#667eea'  (默认紫色)
// taskOpacity = 0.25 + (priority * 0.15)

$color-aggregation: #2d3748;      // 深灰黑 (重叠块背景)
$text-color-on-dark: #ffffff;     // 白色 (重叠块文字)
$default-task-color: #667eea;     // 默认紫色 (无项目时)
```

### 7.2 尺寸规范

- 时间格: 60px (1小时)
- 定位精度: 1px (1分钟)
- 全天事件区: 高度 20px
- 卡片内边距: 4px 8px
- 事件渲染高度: 完全按照实际时长计算（1分钟 = 1px），无最小高度限制
- 标题显示阈值: 高度 < 15px 时隐藏标题，通过 Popover 查看详情
- 聚合徽章: 2px 6px, 字体 10px
- 日程表总高度: 780px (13小时 × 60px)

### 7.3 字体规范

- 超小字: 10px (全天事件、徽章)
- 小字: 12px (时间、任务标题)
- 中字: 14px (Popover标题)

---

## 八、边界情况处理

### 8.1 跨天事件

**处理原则**: 每天独立渲染事件在该天的片段

**示例**: 事件从今天 20:00 到明天 10:00

- **今天**:
  - 20:00-21:00 显示卡片
  - 底部截断 (箭头 + "明天 10:00")
- **明天**:
  - 若满足全天条件 → 全天事件区
  - 否则 8:00-10:00 显示卡片，顶部截断

### 8.2 无安排任务

#### 8.2.1 基本概念

**定义**: 没有指定 `start_time` 和 `end_time` 的任务,称为无安排任务或待办任务。

**创建方式**:
- 在任务创建表单中,开始时间和结束时间字段均为可选
- 留空时间字段则创建为无安排任务

#### 8.2.2 显示区域

**位置**: 日程表下方的独立区域,始终可见

**布局结构**:
```
📝 无安排任务    [2]  ← 任务计数徽章
┌────────────────────────────────────┐
│ ☐ 任务标题                         │
│   [延后按钮]                       │
├────────────────────────────────────┤
│ ☐ 另一个任务                       │
│   [延后按钮]                       │
└────────────────────────────────────┘
```

**空状态** (无任务时):
```
📝 无安排任务
┌────────────────────────────────────┐
│         📅 (日历图标)              │
│       暂无待办任务                  │
│  点击任务可查看详情，通过编辑对话框  │
│        可安排时间                   │
└────────────────────────────────────┘
```

#### 8.2.3 时间管理 (已移除拖拽功能)

##### A. 为无安排任务添加时间

**操作方式**: 通过任务编辑对话框手动设置开始和结束时间

**操作流程**:
1. 点击无安排任务
2. 在弹出的任务详情/编辑对话框中设置开始时间和结束时间
3. 保存后，任务自动移至日程表相应位置

**数据更新**:
```typescript
// 用户在编辑对话框中设置时间后
await taskStore.updateTask(taskId, {
  start_time: startTime.toISOString(),
  end_time: endTime.toISOString(),
  snooze_until: null  // 清除延后状态(如有)
})
```

**用户反馈**:
- 成功提示: "任务已保存"

##### B. 移除已安排任务的时间

**操作方式**: 通过任务编辑对话框清除时间字段

**操作流程**:
1. 点击日程表上的任务
2. 在编辑对话框中清空开始时间和结束时间
3. 保存后，任务自动移至无安排任务列表

**数据更新**:
```typescript
await taskStore.updateTask(taskId, {
  start_time: null,
  end_time: null
})
```

**用户反馈**:
- 成功提示: "任务已移至待办列表"

#### 8.2.4 视觉设计

**交互光标**:
- 任务卡片: `cursor: pointer` (点击查看详情)
- Hover: 卡片轻微上移 + 阴影加深

**区域样式**:
| 状态 | 边框 | 背景 | 阴影 |
|------|------|------|------|
| 正常 | 灰色虚线 | 浅灰色 | 无 |
| Hover | 灰色虚线 | 浅灰色 | 无 |

#### 8.2.5 实现要点

**关键组件**:
- `WeekSchedule.vue`: 主容器，显示无安排任务列表
- `TaskCard.vue`: 日程任务卡片，点击打开详情
- `DashboardView.vue`: 工作台页面，显示延后任务区域（与无安排任务区分）

**事件处理**:
```typescript
// WeekSchedule.vue
function handleTaskClick(task: Task) {
  emit('task-click', task)  // 打开任务详情/编辑对话框
}
```

**区分无安排任务和延后任务**:
```typescript
// 无安排任务: 没有start_time的任务
const unscheduledTasks = tasks.filter(t => !t.start_time && !t.snooze_until)

// 延后任务: 有snooze_until且未到期的任务
const snoozedTasks = tasks.filter(t => {
  if (!t.snooze_until) return false
  return new Date(t.snooze_until) > now
})
```

---

#### 已废弃的拖拽功能 (仅供历史参考)

以下内容为旧版拖拽功能设计，已于2025-11-13移除：

<details>
<summary>点击查看已废弃的拖拽实现代码</summary>

```typescript
// 旧代码 - 已废弃
async function handleTaskDrop(taskId, date, hour, minute) {
  if (hour === -1 || date === null) {
    // 移除时间 → 未安排任务
    await taskStore.updateTask(Number(taskId), {
      start_time: null,
      end_time: null
    })
  } else {
    // 添加时间 → 日程任务
    const startTime = new Date(...)
    const endTime = new Date(startTime)
    endTime.setHours(endTime.getHours() + 1)
    await taskStore.updateTask(Number(taskId), {
      start_time: startTime.toISOString(),
      end_time: endTime.toISOString()
    })
  }
}
```

**拖拽精度**:
- 时间对齐: 15分钟刻度 (比整点更灵活,比1分钟更清晰)
- 计算公式: `snappedMinutes = Math.floor(minutesFromStart / 15) * 15`

### 8.3 已完成任务

- **显示**: 保留在日程表中
- **样式**: 透明度 60%, 删除线

---

## 九、性能优化

### 9.1 计算缓存

- 使用 Vue 的 `computed` 缓存片段计算结果
- 仅在 `tasks` 或 `currentWeekStart` 变化时重新计算

### 9.2 渲染优化

- 使用 `v-if` 避免渲染空时间格
- Popover 懒加载内容

---

## 十、测试用例

### 10.1 全天事件判断

```typescript
// 用例1: 标准全天事件
task = { startTime: '2025-11-04 07:00', endTime: '2025-11-04 22:00' }
date = 2025-11-04
期望: isAllDayEvent(task, date) === true

// 用例2: 非全天事件
task = { startTime: '2025-11-04 10:00', endTime: '2025-11-04 15:00' }
期望: isAllDayEvent(task, date) === false

// 用例3: 跨天全天事件
task = { startTime: '2025-11-04 08:00', endTime: '2025-11-05 21:00' }
期望: isAllDayEvent(task, '2025-11-04') === true
      isAllDayEvent(task, '2025-11-05') === true
```

### 10.2 重叠检测计算

```typescript
// 场景: 两个重叠任务
taskA = { start: '10:00', end: '12:00', priority: 5 }
taskB = { start: '11:00', end: '13:00', priority: 2 }

// 转换为 TaskRenderItem
itemA = { task: taskA, top: 120, height: 120, ... }  // (10-8)*60=120, 2小时=120px
itemB = { task: taskB, top: 180, height: 120, ... }  // (11-8)*60=180, 2小时=120px

// 重叠检测
overlaps = !(itemA.top >= itemB.top + itemB.height ||
             itemA.top + itemA.height <= itemB.top)
         = !(120 >= 300 || 240 <= 180)
         = true

期望结果:
{
  independentItems: [],
  overlappingGroups: [
    [itemA, itemB]  // 这两个任务重叠，创建聚合块
  ]
}

// 聚合块计算
aggregationBlock = {
  id: 'agg-2025-11-04-0',
  top: 120,           // min(120, 180)
  height: 180,        // max(240, 300) - min(120, 180)
  tasks: [taskA, taskB],
  highestPriorityTask: taskA  // priority 5 > 2
}
```

### 10.3 分钟精度计算

```typescript
// 场景: 10:23 - 12:47 的任务
const startMinutes = (10 - 8) * 60 + 23 = 143px
const endMinutes = (12 - 8) * 60 + 47 = 287px
const height = 287 - 143 = 144px

期望 TaskRenderItem:
{
  task: {...},
  top: 143,
  height: 144,
  renderStartTime: new Date('2025-11-04 10:23'),
  renderEndTime: new Date('2025-11-04 12:47')
}
```

---

## 十一、未来扩展

### 11.1 性能增强

- 虚拟滚动 (大量事件时)
- Web Worker 计算分片

### 11.2 功能增强

- 拖拽调整事件时间
- 右键菜单快速操作
- 时间格缩放 (15分钟/30分钟)

### 11.3 视觉增强

- 深色模式适配
- 自定义配色方案
- 动画过渡效果

---

## 十二、参考资料

- Element Plus Popover: https://element-plus.org/zh-CN/component/popover.html
- Vue 3 Composition API: https://vuejs.org/guide/extras/composition-api-faq.html
- CSS Grid Layout: https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Grid_Layout

---

**文档版本**: 3.2
**创建日期**: 2025-11-04
**最后更新**: 2025-11-17
**更新说明**:
- v2.0: 从分片式渲染升级为连续渲染，移除连接线组件，添加扫描线算法和分钟级精度
- v2.1: 优化显示细节 - 调整尺寸规范(全天事件20px、最小事件高度15px)、简化TaskCard显示(只显示标题+Popover详情)、优化AggregationBlock显示(所有任务标题)、时间格式优化(完整日期时间)
- v3.0: 新增全天任务组件 - 单任务使用AllDayTaskCard带Popover详情，多任务使用AllDayAggregation聚合显示(灰色背景+徽章)，完善全天任务交互体验
- v3.1: 新增未安排任务功能 - 支持创建无时间任务、未安排任务区域始终可见(含空状态)、双向拖拽功能(浮动↔日程)、15分钟精度时间对齐、拖拽视觉反馈(高亮+预览)、默认1小时任务时长
- **v3.2 (2025-11-17)**: 颜色系统重构 - 任务卡片改用**项目颜色+优先级透明度**渲染(公式: `opacity = 0.25 + priority × 0.15`)，移除固定的红蓝绿优先级色系；重叠区域改用**黑色配色** (#2d3748, 白色文字) 增强视觉对比度，更易识别任务冲突
