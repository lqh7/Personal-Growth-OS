# ä»»åŠ¡æé†’ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜Personal Growth OSçš„ä»»åŠ¡æé†’åŠŸèƒ½è®¾è®¡æ€è·¯ã€æŠ€æœ¯é€‰å‹å’Œå®ç°ç»†èŠ‚ã€‚

**æ›´æ–°æ—¶é—´**: 2025-11-28
**ç‰ˆæœ¬**: v1.1.0
**ä½œè€…**: Claude + ç”¨æˆ·

### æ›´æ–°è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|------|---------|
| v1.0.0 | 2025-11-27 | åˆå§‹ç‰ˆæœ¬ï¼šå¼€å§‹æé†’åŠŸèƒ½ |
| v1.1.0 | 2025-11-28 | æ·»åŠ ç»“æŸæé†’åŠŸèƒ½ï¼Œä¼˜åŒ–é’‰é’‰æ¶ˆæ¯è§†è§‰ä½“éªŒ |

---

## 1. åŠŸèƒ½éœ€æ±‚

### 1.1 æ ¸å¿ƒéœ€æ±‚

ä¸ºæ‰€æœ‰æœ‰æ—¶é—´å®‰æ’çš„ä»»åŠ¡å‘é€é’‰é’‰æé†’:
- **å¼€å§‹æé†’**: `start_time`å‰10åˆ†é’Ÿé€šè¿‡é’‰é’‰æœºå™¨äººå‘é€æé†’æ¶ˆæ¯
- **ç»“æŸæé†’**: `end_time`åˆ°è¾¾æ—¶é€šè¿‡é’‰é’‰æœºå™¨äººå‘é€æé†’æ¶ˆæ¯

### 1.2 æ¶ˆæ¯å†…å®¹

æé†’æ¶ˆæ¯åº”åŒ…å«:
- ä»»åŠ¡æ ‡é¢˜
- ä»»åŠ¡æè¿° (ä»…å¼€å§‹æé†’)
- å¼€å§‹æ—¶é—´
- ç»“æŸæ—¶é—´
- æ‰€å±é¡¹ç›®

### 1.3 æ¶ˆæ¯ç±»å‹

| æé†’ç±»å‹ | è§¦å‘æ—¶æœº | è¯´æ˜ |
|---------|---------|------|
| å¼€å§‹æé†’ | `start_time - 10åˆ†é’Ÿ` | æå‰10åˆ†é’Ÿæé†’å‡†å¤‡ |
| ç»“æŸæé†’ | `end_time` åˆ°è¾¾æ—¶ | ä»»åŠ¡æ—¶é—´ç»“æŸï¼Œæé†’æ£€æŸ¥å®Œæˆæƒ…å†µ |

### 1.4 é…ç½®éœ€æ±‚

- æ”¯æŒç¯å¢ƒå˜é‡é…ç½®(`.env`æ–‡ä»¶)
- æ”¯æŒå‰ç«¯è®¾ç½®é¡µé¢é…ç½®
- æ”¯æŒå¯ç”¨/ç¦ç”¨æé†’åŠŸèƒ½
- æ”¯æŒé’‰é’‰webhookå’ŒåŠ ç­¾å¯†é’¥é…ç½®

---

## 2. æŠ€æœ¯æ–¹æ¡ˆ

### 2.1 è°ƒåº¦ç­–ç•¥: å®šæœŸæ‰«æ vs ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºJob

#### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|-----|------|---------|
| **ä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºscheduled job** | ç²¾ç¡®,æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹è°ƒåº¦ | ä»»åŠ¡é‡å¤§æ—¶jobæ•°çˆ†ç‚¸,è°ƒåº¦å™¨è´Ÿè½½é«˜,ä»»åŠ¡å˜æ›´éœ€åŒæ­¥job | ä»»åŠ¡é‡å°‘(<100) |
| **å®šæœŸæ‰«ææ•°æ®åº“** âœ… | è°ƒåº¦å™¨è´Ÿè½½æ’å®š,ä»»åŠ¡å˜æ›´æ— éœ€åŒæ­¥,ç®€å•å¯é  | æ‰«æé¢‘ç‡å—é™(1åˆ†é’Ÿ),æœ‰è½»å¾®å»¶è¿Ÿ | ä»»åŠ¡é‡å¤§,ä»»åŠ¡é¢‘ç¹å˜æ›´ |

#### é€‰æ‹©ç†ç”±

æœ¬ç³»ç»Ÿé‡‡ç”¨**å®šæœŸæ‰«ææ•°æ®åº“**æ–¹æ¡ˆ,åŸå› :

1. **æ‰«æé—´éš”çŸ­**: æ¯åˆ†é’Ÿæ‰«æä¸€æ¬¡,10åˆ†é’Ÿæé†’çª—å£è¶³å¤Ÿç²¾ç¡®
2. **ä»»åŠ¡é‡å¯æ‰©å±•**: å³ä½¿æœ‰10ä¸‡ä¸ªä»»åŠ¡,æ‰«æçª—å£åªæŸ¥è¯¢10-11åˆ†é’Ÿå†…çš„å°‘é‡ä»»åŠ¡
3. **å˜æ›´å‹å¥½**: ç”¨æˆ·ä¿®æ”¹ä»»åŠ¡æ—¶é—´å,ä¸‹æ¬¡æ‰«æè‡ªåŠ¨ç”Ÿæ•ˆ,æ— éœ€æ‰‹åŠ¨åŒæ­¥è°ƒåº¦å™¨çŠ¶æ€
4. **å®ç°ç®€å•**: åªéœ€ä¸€ä¸ªå®šæ—¶job,ç»´æŠ¤æˆæœ¬ä½

#### æ‰«ææŸ¥è¯¢é€»è¾‘

**å¼€å§‹æé†’æŸ¥è¯¢** (ä»»åŠ¡å¼€å§‹å‰10-11åˆ†é’Ÿ):
```sql
SELECT * FROM tasks
WHERE start_time IS NOT NULL
  AND start_time BETWEEN (NOW() + INTERVAL '10 minutes') AND (NOW() + INTERVAL '11 minutes')
  AND status NOT IN ('completed', 'archived')
  AND (last_reminder_sent_at IS NULL OR last_reminder_sent_at < start_time - INTERVAL '10 minutes')
```

**ç»“æŸæé†’æŸ¥è¯¢** (ä»»åŠ¡ç»“æŸæ—¶é—´åˆšè¿‡):
```sql
SELECT * FROM tasks
WHERE end_time IS NOT NULL
  AND end_time BETWEEN (NOW() - INTERVAL '1 minute') AND NOW()
  AND status NOT IN ('completed', 'archived')
  AND (last_end_reminder_sent_at IS NULL OR last_end_reminder_sent_at < end_time)
```

**æŸ¥è¯¢çª—å£è®¾è®¡**:
- **å¼€å§‹æé†’**: 10-11åˆ†é’Ÿçª—å£ï¼Œæ¯ä¸ªä»»åŠ¡åªä¼šè¢«å‘½ä¸­ä¸€æ¬¡
- **ç»“æŸæé†’**: 0-1åˆ†é’Ÿçª—å£ï¼Œåœ¨end_timeåˆ°è¾¾åçš„1åˆ†é’Ÿå†…è§¦å‘

---

### 2.2 é˜²é‡å¤æé†’æœºåˆ¶

#### é—®é¢˜

å¦‚æœä»»åŠ¡çš„`start_time`è¢«ç”¨æˆ·ä¿®æ”¹,å¦‚ä½•ä¿è¯:
- åŸæ—¶é—´å·²å‘é€æé†’,ä¿®æ”¹åä¸å†å‘é€
- ä½†å¦‚æœæ”¹åˆ°æœªæ¥å¾ˆè¿œçš„æ—¶é—´,åº”è¯¥é‡æ–°æé†’

#### è§£å†³æ–¹æ¡ˆ

åœ¨Taskæ¨¡å‹ä¸­æ·»åŠ ä¸¤ä¸ªå­—æ®µï¼š

```python
# å¼€å§‹æé†’é˜²é‡å¤
last_reminder_sent_at: Mapped[datetime] = mapped_column(
    DateTime,
    nullable=True,
    comment="Last time a start reminder was sent for this task (é˜²æ­¢é‡å¤æé†’)"
)

# ç»“æŸæé†’é˜²é‡å¤ (v1.1.0æ–°å¢)
last_end_reminder_sent_at: Mapped[datetime] = mapped_column(
    DateTime,
    nullable=True,
    comment="Last time an end reminder was sent for this task (é˜²æ­¢é‡å¤æé†’)"
)
```

**å¼€å§‹æé†’å»é‡é€»è¾‘**:
```python
(Task.last_reminder_sent_at.is_(None)) |  # ä»æœªæé†’è¿‡
(Task.last_reminder_sent_at < Task.start_time - timedelta(minutes=10))  # æˆ–start_timeè¢«æ”¹åˆ°10åˆ†é’Ÿå
```

**ç»“æŸæé†’å»é‡é€»è¾‘**:
```python
(Task.last_end_reminder_sent_at.is_(None)) |  # ä»æœªæé†’è¿‡
(Task.last_end_reminder_sent_at < Task.end_time)  # æˆ–end_timeè¢«ä¿®æ”¹åˆ°æ›´æ™š
```

**ç¤ºä¾‹åœºæ™¯**:

| åœºæ™¯ | start_time | last_reminder_sent_at | æ˜¯å¦æé†’ | åŸå›  |
|------|-----------|---------------------|---------|------|
| æ–°å»ºä»»åŠ¡ | 2025-12-01 10:00 | NULL | âœ… | ä»æœªæé†’ |
| å·²æé†’ä»»åŠ¡ | 2025-12-01 10:00 | 2025-12-01 09:50 | âŒ | å·²åœ¨09:50æé†’è¿‡ |
| æ—¶é—´å°å¹…ä¿®æ”¹ | 2025-12-01 10:05 | 2025-12-01 09:50 | âŒ | 09:50æé†’æ—¶è·ç¦»09:55è¿˜ä¸åˆ°10åˆ†é’Ÿ |
| æ—¶é—´å¤§å¹…ä¿®æ”¹ | 2025-12-01 15:00 | 2025-12-01 09:50 | âœ… | 09:50è·ç¦»15:00è¶…è¿‡10åˆ†é’Ÿ,éœ€é‡æ–°æé†’ |

---

### 2.3 APScheduleræ¶æ„é€‰æ‹©

#### ç‰ˆæœ¬é€‰æ‹©: v3.10.4 ç¨³å®šç‰ˆ

| é€‰é¡¹ | ç†ç”± |
|------|------|
| APScheduler 4.0 (é¢„å‘å¸ƒ) | âŒ ä¸ç¨³å®š,APIå˜åŒ–å¤§,ç”Ÿäº§ç¯å¢ƒé£é™©é«˜ |
| **APScheduler 3.10.4** âœ… | ç¨³å®šæˆç†Ÿ,ç¤¾åŒºæ”¯æŒå¥½,å†…å­˜å­˜å‚¨è½»é‡é«˜æ•ˆ |

#### æŒä¹…åŒ–æ–¹æ¡ˆ: MemoryJobStoreï¼ˆå†…å­˜å­˜å‚¨ï¼‰

```python
jobstores = {
    'default': MemoryJobStore()
}
```

**é€‰æ‹©ç†ç”±**:
- **è°ƒåº¦ä»»åŠ¡å›ºå®š**: ç³»ç»Ÿåªæœ‰ä¸€ä¸ªæ¯åˆ†é’Ÿæ‰§è¡Œçš„æ‰«æ jobï¼Œæ— éœ€æŒä¹…åŒ–
- **æ€§èƒ½ä¼˜åŒ–**: é¿å…æ¯æ¬¡è°ƒåº¦éƒ½å†™å…¥ PostgreSQLï¼Œå‡å°‘æ•°æ®åº“ I/O
- **æ¶æ„ç®€åŒ–**: å†…å­˜å­˜å‚¨æ›´è½»é‡ï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦
- **å¯é æ€§ä¿éšœ**: é€šè¿‡å¯åŠ¨æ—¶è¡¥å‘æœºåˆ¶å’Œæ•°æ®åº“é˜²é‡å¤å­—æ®µä¿è¯æé†’å¯é æ€§

**æ³¨æ„äº‹é¡¹**:
- Job é…ç½®åœ¨æ¯æ¬¡æœåŠ¡å¯åŠ¨æ—¶é‡æ–°æ·»åŠ ï¼ˆè‡ªåŠ¨å®Œæˆï¼‰
- ä¸æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²çš„è‡ªåŠ¨åˆ†å¸ƒå¼é”ï¼ˆå½“å‰ä¸ºå•å®ä¾‹éƒ¨ç½²ï¼Œæœªæ¥å¯é€šè¿‡ç¯å¢ƒå˜é‡æˆ– Redis é”è§£å†³ï¼‰

#### è°ƒåº¦å™¨é…ç½®

```python
scheduler = BackgroundScheduler(
    jobstores=jobstores,
    executors={'default': ThreadPoolExecutor(max_workers=10)},
    job_defaults={
        'coalesce': True,  # åˆå¹¶å¤šæ¬¡é”™è¿‡çš„æ‰§è¡Œ
        'max_instances': 1,  # åŒä¸€jobåŒæ—¶åªè¿è¡Œä¸€ä¸ªå®ä¾‹
        'misfire_grace_time': 60  # é”™è¿‡æ‰§è¡Œå60ç§’å†…ä»ç„¶æ‰§è¡Œ
    },
    timezone='Asia/Shanghai'
)
```

**å…³é”®å‚æ•°è¯´æ˜**:
- `coalesce=True`: å¦‚æœæœåŠ¡åœæœºå¯¼è‡´é”™è¿‡å¤šæ¬¡æ‰§è¡Œ,æ¢å¤ååªæ‰§è¡Œä¸€æ¬¡(è€Œéè¡¥å¿æ‰§è¡Œ)
- `max_instances=1`: é˜²æ­¢æ‰«æä»»åŠ¡é‡å æ‰§è¡Œ
- `misfire_grace_time=60`: å¦‚æœè°ƒåº¦å™¨ç¹å¿™å¯¼è‡´æ™šæ‰§è¡Œ,60ç§’å†…ä»ç„¶æ‰§è¡Œ

---

### 2.4 é”™è¿‡æé†’è¡¥å‘æœºåˆ¶

#### é—®é¢˜èƒŒæ™¯

ä½¿ç”¨ MemoryJobStore åï¼Œè°ƒåº¦å™¨çŠ¶æ€ä¸å†æŒä¹…åŒ–ã€‚å¦‚æœæœåŠ¡åœ¨ä»»åŠ¡åº”è¯¥è¢«æé†’æ—¶åœæœºï¼ˆå¦‚é‡å¯ã€å´©æºƒï¼‰ï¼Œæé†’ä¼šä¸¢å¤±ã€‚

#### è§£å†³æ–¹æ¡ˆï¼šå¯åŠ¨æ—¶è¡¥å‘

åœ¨æœåŠ¡å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨æ‰«æè¿‡å» 10 åˆ†é’Ÿå†…åº”è¯¥è¢«æé†’ä½†æœªæé†’çš„ä»»åŠ¡ï¼Œç«‹å³è¡¥å‘ã€‚

**è¡¥å‘é€»è¾‘**ï¼ˆ`task_reminder_service.py`ï¼‰:
```python
def check_and_send_missed_reminders(self):
    """
    æœåŠ¡å¯åŠ¨æ—¶æ£€æŸ¥å¹¶è¡¥å‘é”™è¿‡çš„æé†’ã€‚
    æ‰«æè¿‡å» 10 åˆ†é’Ÿå†… start_time åœ¨ [now-10min, now] ä¸”æœªæé†’çš„ä»»åŠ¡ã€‚
    """
    now = datetime.now()
    past_reminder_window_start = now - timedelta(minutes=10)

    tasks = db.query(Task).filter(
        and_(
            Task.start_time >= past_reminder_window_start,
            Task.start_time <= now,
            Task.status.notin_(['completed', 'archived']),
            # é˜²é‡å¤ï¼šæœªæé†’è¿‡ï¼Œæˆ– last_reminder_sent_at æ—©äºåº”è¯¥æé†’çš„æ—¶é—´
            or_(
                Task.last_reminder_sent_at.is_(None),
                Task.last_reminder_sent_at < Task.start_time - timedelta(minutes=10)
            )
        )
    ).all()

    # å‘é€è¡¥å‘æé†’å¹¶æ›´æ–° last_reminder_sent_at
```

**è°ƒç”¨æ—¶æœº**ï¼ˆ`scheduler.py`ï¼‰:
```python
# å¯åŠ¨è°ƒåº¦å™¨åç«‹å³æ£€æŸ¥
scheduler.start()
reminder_service.check_and_send_missed_reminders()
```

**è¡¥å‘çª—å£è®¾è®¡**: 10 åˆ†é’Ÿ
- æœåŠ¡åœæœº â‰¤10 åˆ†é’Ÿï¼šæ‰€æœ‰é”™è¿‡çš„æé†’éƒ½ä¼šè¡¥å‘
- æœåŠ¡åœæœº >10 åˆ†é’Ÿï¼šè¶…è¿‡ 10 åˆ†é’Ÿçš„æé†’ä¸è¡¥å‘ï¼ˆè®¤ä¸ºå·²è¿‡æ—¶ï¼‰
- é˜²æ­¢è¡¥å‘çª—å£è¿‡å¤§å¯¼è‡´å¯åŠ¨æ—¶å‘é€å¤§é‡è¿‡æ—¶æé†’

**ä¸é˜²é‡å¤æœºåˆ¶çš„é…åˆ**:
- è¡¥å‘é€»è¾‘ä½¿ç”¨ç›¸åŒçš„ `last_reminder_sent_at` å­—æ®µé˜²é‡å¤
- å³ä½¿æœåŠ¡é¢‘ç¹é‡å¯ï¼Œæ¯ä¸ªä»»åŠ¡æœ€å¤šåªä¼šæé†’ä¸€æ¬¡
- å¦‚æœä»»åŠ¡çš„ start_time è¢«ä¿®æ”¹åˆ°æœªæ¥å¾ˆä¹…ï¼Œä¼šé‡æ–°è§¦å‘æé†’

---

### 2.5 é’‰é’‰æ¶ˆæ¯æ ¼å¼è®¾è®¡ (v1.1.0ä¼˜åŒ–)

#### æ¶ˆæ¯ç±»å‹é€‰æ‹©: Markdown

ç³»ç»Ÿä½¿ç”¨ç¾åŒ–çš„Markdownæ ¼å¼ï¼Œæä¾›æ›´å¥½çš„è§†è§‰ä½“éªŒï¼š

**å¼€å§‹æé†’æ¶ˆæ¯**:
```python
title = f"â° ä»»åŠ¡å³å°†å¼€å§‹: {task.title}"
content = f"""## â° ä»»åŠ¡å³å°†å¼€å§‹

---

ğŸ¯ **ä»»åŠ¡åç§°**

> {task.title}

ğŸ“ **ä»»åŠ¡æè¿°**

> {description}

â±ï¸ **æ—¶é—´å®‰æ’**

> ğŸŸ¢ å¼€å§‹ï¼š{start_str}
>
> ğŸ”´ ç»“æŸï¼š{end_str}

ğŸ“‚ **æ‰€å±é¡¹ç›®**

> {project_name or 'é»˜è®¤'}

---

ğŸ’¡ **æ¸©é¦¨æç¤º**ï¼šä»»åŠ¡å°†åœ¨ **10åˆ†é’Ÿå** å¼€å§‹ï¼Œè¯·åšå¥½å‡†å¤‡ï¼
"""
```

**ç»“æŸæé†’æ¶ˆæ¯**:
```python
title = f"âœ… ä»»åŠ¡æ—¶é—´å·²åˆ°: {task.title}"
content = f"""## âœ… ä»»åŠ¡æ—¶é—´å·²åˆ°

---

ğŸ¯ **ä»»åŠ¡åç§°**

> {task.title}

â±ï¸ **æ—¶é—´å®‰æ’**

> ğŸŸ¢ å¼€å§‹ï¼š{start_str}
>
> ğŸ”´ ç»“æŸï¼š{end_str}ï¼ˆå·²åˆ°æ—¶é—´ï¼‰

ğŸ“‚ **æ‰€å±é¡¹ç›®**

> {project_name or 'é»˜è®¤'}

---

ğŸ‰ **ä»»åŠ¡æ—¶é—´ç»“æŸ**ï¼Œè¯·æ£€æŸ¥å®Œæˆæƒ…å†µå¹¶æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼
"""
```

#### è®¾è®¡ç†ç”±

- **Markdownæ ¼å¼**: é’‰é’‰åŸç”Ÿæ”¯æŒ,æ’ç‰ˆæ¸…æ™°
- **åˆ†éš”çº¿ç»“æ„**: ä½¿ç”¨`---`åˆ†éš”ä¸åŒä¿¡æ¯åŒºå—
- **å¼•ç”¨æ ·å¼**: ä½¿ç”¨`>`å¼•ç”¨å—è®©ä¿¡æ¯æ›´çªå‡º
- **EmojiåŒºåˆ†**: å¼€å§‹ç”¨â°ï¼Œç»“æŸç”¨âœ…ï¼Œç›´è§‚åŒºåˆ†æ¶ˆæ¯ç±»å‹
- **é¢œè‰²è¯­ä¹‰**: å¼€å§‹æ—¶é—´ç”¨ğŸŸ¢ï¼Œç»“æŸæ—¶é—´ç”¨ğŸ”´
- **ä¸@æ‰€æœ‰äºº**: é¿å…æ‰“æ‰°éä»»åŠ¡è´Ÿè´£äºº

---

## 3. ç³»ç»Ÿæ¶æ„

### 3.1 æ•´ä½“æ¶æ„å›¾

```
FastAPI Application (ç«¯å£8000)
â”œâ”€â”€ Lifespan Events
â”‚   â”œâ”€â”€ startup â†’ init_scheduler()
â”‚   â”‚   â”œâ”€â”€ æ¸…ç† apscheduler_jobs è¡¨ï¼ˆé—ç•™è¡¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ å¯åŠ¨ APScheduler
â”‚   â”‚   â””â”€â”€ è¡¥å‘é”™è¿‡çš„æé†’ (check_and_send_missed_reminders)
â”‚   â””â”€â”€ shutdown â†’ shutdown_scheduler()
â”‚
â”œâ”€â”€ APScheduler (åå°çº¿ç¨‹)
â”‚   â”œâ”€â”€ MemoryJobStore (å†…å­˜å­˜å‚¨ï¼Œè½»é‡é«˜æ•ˆ)
â”‚   â”œâ”€â”€ ThreadPoolExecutor (jobæ‰§è¡Œå™¨)
â”‚   â””â”€â”€ IntervalTrigger (æ¯åˆ†é’Ÿè§¦å‘)
â”‚       â””â”€â”€ task_reminder_service.check_and_send_reminders()
â”‚
â”œâ”€â”€ Services Layer
â”‚   â”œâ”€â”€ DingTalkService (é’‰é’‰æ¶ˆæ¯å‘é€)
â”‚   â”‚   â”œâ”€â”€ send_task_start_reminder(task, project_name)
â”‚   â”‚   â”œâ”€â”€ send_task_end_reminder(task, project_name)
â”‚   â”‚   â””â”€â”€ send_text(msg)
â”‚   â””â”€â”€ TaskReminderService (æé†’ä¸šåŠ¡é€»è¾‘)
â”‚       â”œâ”€â”€ check_and_send_reminders() (æ¯åˆ†é’Ÿ)
â”‚       â”‚   â”œâ”€â”€ _send_start_reminders() (å¼€å§‹æé†’)
â”‚       â”‚   â””â”€â”€ _send_end_reminders() (ç»“æŸæé†’)
â”‚       â””â”€â”€ check_and_send_missed_reminders() (å¯åŠ¨æ—¶)
â”‚           â””â”€â”€ _send_missed_end_reminders() (è¡¥å‘ç»“æŸæé†’)
â”‚
â””â”€â”€ Database (PostgreSQL)
    â””â”€â”€ tasksè¡¨
        â”œâ”€â”€ last_reminder_sent_at (å¼€å§‹æé†’é˜²é‡å¤)
        â””â”€â”€ last_end_reminder_sent_at (ç»“æŸæé†’é˜²é‡å¤)
```

### 3.2 æ•°æ®æµç¨‹

**å¼€å§‹æé†’æµç¨‹**:
```
[æ¯åˆ†é’Ÿè§¦å‘]
    â†“
[TaskReminderService._send_start_reminders()]
    â†“
[SQLæŸ¥è¯¢: 10-11åˆ†é’Ÿåå¼€å§‹çš„ä»»åŠ¡]
    â†“
[éå†ä»»åŠ¡åˆ—è¡¨]
    â†“
[DingTalkService.send_task_start_reminder()]
    â†“
[é’‰é’‰API: POST webhook]
    â†“
[æ›´æ–°task.last_reminder_sent_at = now()]
    â†“
[æäº¤æ•°æ®åº“äº‹åŠ¡]
```

**ç»“æŸæé†’æµç¨‹**:
```
[æ¯åˆ†é’Ÿè§¦å‘]
    â†“
[TaskReminderService._send_end_reminders()]
    â†“
[SQLæŸ¥è¯¢: 0-1åˆ†é’Ÿå‰ç»“æŸçš„ä»»åŠ¡]
    â†“
[éå†ä»»åŠ¡åˆ—è¡¨]
    â†“
[DingTalkService.send_task_end_reminder()]
    â†“
[é’‰é’‰API: POST webhook]
    â†“
[æ›´æ–°task.last_end_reminder_sent_at = now()]
    â†“
[æäº¤æ•°æ®åº“äº‹åŠ¡]
```

---

## 4. å…³é”®å®ç°ç»†èŠ‚

### 4.1 æ•°æ®åº“å˜æ›´

**Taskæ¨¡å‹æ–°å¢å­—æ®µ**:
```python
# å¼€å§‹æé†’é˜²é‡å¤ (v1.0.0)
last_reminder_sent_at: Mapped[datetime] = mapped_column(
    DateTime,
    nullable=True,
    comment="Last time a start reminder was sent for this task (é˜²æ­¢é‡å¤æé†’)"
)

# ç»“æŸæé†’é˜²é‡å¤ (v1.1.0æ–°å¢)
last_end_reminder_sent_at: Mapped[datetime] = mapped_column(
    DateTime,
    nullable=True,
    comment="Last time an end reminder was sent for this task (é˜²æ­¢é‡å¤æé†’)"
)
```

**è¿ç§»è¯´æ˜**:
- ç°æœ‰ä»»åŠ¡è¯¥å­—æ®µé»˜è®¤ä¸ºNULL
- æ— éœ€æ‰‹åŠ¨è¿ç§»è„šæœ¬(SQLAlchemyè‡ªåŠ¨åˆ›å»º)
- PostgreSQLä¼šè‡ªåŠ¨æ·»åŠ åˆ—

### 4.2 é…ç½®ç®¡ç†

#### ç¯å¢ƒå˜é‡ (`.env`)

```bash
# DingTalk Notification Settings
DINGTALK_WEBHOOK=""  # é’‰é’‰webhook URL
DINGTALK_SECRET=""   # åŠ ç­¾å¯†é’¥(å¯é€‰)
ENABLE_TASK_REMINDER=True  # å¯ç”¨/ç¦ç”¨æé†’
```

#### å‰ç«¯é…ç½®ç•Œé¢

ç”¨æˆ·å¯åœ¨ `http://localhost:5173/settings` é¡µé¢é…ç½®:
- å¯ç”¨/ç¦ç”¨ä»»åŠ¡æé†’å¼€å…³
- Webhook URLè¾“å…¥æ¡†
- åŠ ç­¾å¯†é’¥è¾“å…¥æ¡†(å¯†ç æ˜¾ç¤º/éšè—)

é…ç½®è‡ªåŠ¨ä¿å­˜åˆ° `backend/.env`,å¹¶é€šè¿‡çƒ­åŠ è½½ç«‹å³ç”Ÿæ•ˆã€‚

### 4.3 æ—¶åŒºå¤„ç†

**ç»Ÿä¸€ä½¿ç”¨Asia/Shanghaiæ—¶åŒº**:
```python
scheduler = BackgroundScheduler(
    timezone='Asia/Shanghai'
)
```

**æ—¶é—´å­—æ®µè¯´æ˜**:
- Taskæ¨¡å‹çš„æ—¶é—´å­—æ®µä½¿ç”¨`datetime.now()`(æœ¬åœ°æ—¶é—´)
- å‰ç«¯æ˜¾ç¤ºæ—¶é—´ä¸æ•°æ®åº“æ—¶é—´ä¸€è‡´
- æŸ¥è¯¢æ—¶ä½¿ç”¨`datetime.now()`(æœåŠ¡å™¨æœ¬åœ°æ—¶é—´)

---

## 5. éƒ¨ç½²å’Œè¿ç»´

### 5.1 å¼€å‘ç¯å¢ƒé…ç½®

1. **å»ºç«‹SSHéš§é“åˆ°æ•°æ®åº“**:
   ```bash
   ssh -L 5432:127.0.0.1:5432 root@139.224.62.197
   ```
   ä¿æŒæ­¤ç»ˆç«¯å¼€å¯,`DATABASE_URL`ä½¿ç”¨`postgresql://localhost:5432/...`

2. **å®‰è£…ä¾èµ–**:
   ```bash
   cd backend
   uv pip install "apscheduler==3.10.4" DingtalkChatbot
   ```

3. **é…ç½®é’‰é’‰**:
   - åœ¨é’‰é’‰ç¾¤åˆ›å»ºè‡ªå®šä¹‰æœºå™¨äºº
   - å¤åˆ¶webhook URLåˆ°`backend/.env`
   - å¦‚å¯ç”¨åŠ ç­¾,å¤åˆ¶å¯†é’¥åˆ°`DINGTALK_SECRET`

4. **å¯åŠ¨æœåŠ¡**:
   ```bash
   python -m uvicorn app.main:app --reload
   ```

### 5.2 ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¦æ±‚**:
   - PostgreSQL 12+
   - å·²å®‰è£…pgvectoræ‰©å±•(è™½ç„¶æé†’åŠŸèƒ½ä¸ç”¨,ä½†ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†éœ€è¦)

2. **æ€§èƒ½è€ƒè™‘**:
   - æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡SQLæŸ¥è¯¢,ç´¢å¼•ä¼˜åŒ–:
     ```sql
     CREATE INDEX idx_tasks_start_time ON tasks(start_time);
     CREATE INDEX idx_tasks_status ON tasks(status);
     ```
   - å¯åŠ¨æ—¶è¡¥å‘æŸ¥è¯¢ä¹Ÿå—ç›Šäºç›¸åŒç´¢å¼•

3. **éƒ¨ç½²æ¨¡å¼**:
   - **æ¨è**: å•å®ä¾‹éƒ¨ç½²ï¼ˆMemoryJobStore ä¸æ”¯æŒå¤šå®ä¾‹åˆ†å¸ƒå¼é”ï¼‰
   - **æœªæ¥æ‰©å±•**: å¦‚éœ€å¤šå®ä¾‹ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹æ¡ˆä¹‹ä¸€å®ç°ï¼š
     - ç¯å¢ƒå˜é‡æ§åˆ¶åªåœ¨ä¸€ä¸ªå®ä¾‹å¯åŠ¨ scheduler
     - ä½¿ç”¨ Redis åˆ†å¸ƒå¼é”
     - å›é€€åˆ° SQLAlchemyJobStoreï¼ˆå¦‚ç¡®å®éœ€è¦æŒä¹…åŒ–ï¼‰

4. **ç›‘æ§å»ºè®®**:
   - ç›‘æ§è°ƒåº¦å™¨æ—¥å¿—: `âœ… Reminder sent for task`
   - ç›‘æ§è¡¥å‘æ—¥å¿—: `[Startup] Sent missed reminder`
   - ç›‘æ§é’‰é’‰APIé”™è¯¯: `âŒ Failed to send reminder`
   - è®¾ç½®å‘Šè­¦: è¿ç»­5æ¬¡å‘é€å¤±è´¥åº”è§¦å‘å‘Šè­¦

5. **æœåŠ¡é‡å¯**:
   - é‡å¯æ—¶ä¼šè‡ªåŠ¨è¡¥å‘è¿‡å» 10 åˆ†é’Ÿå†…é”™è¿‡çš„æé†’
   - å¦‚éœ€ç»´æŠ¤ï¼Œå»ºè®®åœ¨æ²¡æœ‰é‡è¦ä»»åŠ¡çš„æ—¶æ®µè¿›è¡Œ

### 5.3 æ•…éšœå¤„ç†

| é—®é¢˜ | ç°è±¡ | æ’æŸ¥æ­¥éª¤ |
|------|------|---------|
| æé†’æœªå‘é€ | åˆ°æ—¶é—´äº†ä½†æ²¡æ”¶åˆ°é’‰é’‰æ¶ˆæ¯ | 1. æ£€æŸ¥`ENABLE_TASK_REMINDER=True`<br>2. æ£€æŸ¥webhooké…ç½®æ­£ç¡®<br>3. æŸ¥çœ‹åç«¯æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯<br>4. æ£€æŸ¥ä»»åŠ¡`start_time`æ˜¯å¦æ­£ç¡® |
| é‡å¤æé†’ | åŒä¸€ä¸ªä»»åŠ¡æ”¶åˆ°å¤šæ¬¡æé†’ | 1. æ£€æŸ¥`last_reminder_sent_at`å­—æ®µæ˜¯å¦æ›´æ–°<br>2. æ£€æŸ¥æ•°æ®åº“äº‹åŠ¡æ˜¯å¦æ­£å¸¸æäº¤<br>3. æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªæœåŠ¡å®ä¾‹æœªä½¿ç”¨åˆ†å¸ƒå¼é” |
| è°ƒåº¦å™¨æœªå¯åŠ¨ | æ—¥å¿—æ— APScheduler started | 1. æ£€æŸ¥PostgreSQLè¿æ¥<br>2. æ£€æŸ¥`apscheduler_jobs`è¡¨æ˜¯å¦å­˜åœ¨<br>3. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—é”™è¯¯ä¿¡æ¯ |

---

## 6. æœªæ¥æ‰©å±•æ–¹å‘

### 6.1 å¤šé€šçŸ¥æ¸ é“

åœ¨`DingTalkService`åŸºç¡€ä¸ŠæŠ½è±¡`NotificationService`æ¥å£:
- ä¼ä¸šå¾®ä¿¡
- é£ä¹¦
- é‚®ä»¶
- çŸ­ä¿¡

### 6.2 è‡ªå®šä¹‰æé†’æ—¶é—´

åœ¨Taskæ¨¡å‹æ·»åŠ `reminder_minutes_before`å­—æ®µ:
```python
reminder_minutes_before: int = 10  # é»˜è®¤10åˆ†é’Ÿ
```

æŸ¥è¯¢é€»è¾‘è°ƒæ•´ä¸º:
```sql
WHERE start_time BETWEEN
    (NOW() + INTERVAL (reminder_minutes_before || ' minutes'))
    AND
    (NOW() + INTERVAL ((reminder_minutes_before + 1) || ' minutes'))
```

### 6.3 æé†’å†å²è®°å½•

åˆ›å»º`task_reminder_log`è¡¨è®°å½•æ‰€æœ‰æé†’:
```python
class TaskReminderLog(Base):
    id: int
    task_id: int
    sent_at: datetime
    success: bool
    error_message: str
    notification_channel: str  # dingtalk, wechat, etc.
```

ç”¨äº:
- æ•…éšœæ’æŸ¥
- ç»Ÿè®¡åˆ†æ
- ç”¨æˆ·æŸ¥è¯¢æé†’å†å²

### 6.4 æ™ºèƒ½æé†’

åŸºäºç”¨æˆ·ä¹ æƒ¯è°ƒæ•´æé†’æ—¶é—´:
- æ—©ä¸Šä»»åŠ¡: æå‰30åˆ†é’Ÿæé†’
- ä¸‹åˆä»»åŠ¡: æå‰10åˆ†é’Ÿæé†’
- é€šè¿‡AIåˆ†æç”¨æˆ·ä»»åŠ¡å®Œæˆæ¨¡å¼

---

## 7. æ€»ç»“

### 7.1 æŠ€æœ¯äº®ç‚¹

1. **å®šæœŸæ‰«æç­–ç•¥**: ç®€å•å¯é ,æ‰©å±•æ€§å¼º
2. **é˜²é‡å¤æé†’æœºåˆ¶**: é€šè¿‡`last_reminder_sent_at`ä¼˜é›…è§£å†³æ—¶é—´å˜æ›´é—®é¢˜
3. **APScheduler 3.10.4**: ç¨³å®šç‰ˆæœ¬,PostgreSQLæŒä¹…åŒ–,å¤šå®ä¾‹æ”¯æŒ
4. **å‰åç«¯é…ç½®åŒè½¨**: æ—¢æ”¯æŒç¯å¢ƒå˜é‡,ä¹Ÿæ”¯æŒWeb UIé…ç½®

### 7.2 ç³»ç»Ÿç‰¹ç‚¹

- âœ… è½»é‡çº§: æ— éœ€é¢å¤–éƒ¨ç½²ç»„ä»¶(Redis/Celery)ï¼Œå†…å­˜å­˜å‚¨é›¶å¼€é”€
- âœ… å¯é æ€§: å¯åŠ¨æ—¶è¡¥å‘æœºåˆ¶ + æ•°æ®åº“é˜²é‡å¤å­—æ®µï¼Œç¡®ä¿æé†’ä¸ä¸¢å¤±
- âœ… é«˜æ€§èƒ½: å†…å­˜è°ƒåº¦ï¼Œæ— éœ€æŒä¹…åŒ– I/Oï¼Œå¯åŠ¨æ›´å¿«
- âœ… æ˜“ç»´æŠ¤: ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ—¥å¿—å®Œå–„ï¼Œæ•…éšœæ˜“æ’æŸ¥
- âœ… æ¶æ„ç®€æ´: èŒè´£åˆ†ç¦»ï¼Œè°ƒåº¦ç”± APScheduler ç®¡ç†ï¼Œé˜²é‡å¤ç”±æ•°æ®åº“ç®¡ç†

### 7.3 æ€§èƒ½æŒ‡æ ‡

- **æ‰«æå»¶è¿Ÿ**: <1ç§’(æ¯åˆ†é’Ÿä¸€æ¬¡)
- **æé†’ç²¾åº¦**: Â±1åˆ†é’Ÿ(10-11åˆ†é’Ÿçª—å£)
- **æ”¯æŒä»»åŠ¡é‡**: 10ä¸‡+ä»»åŠ¡(ç´¢å¼•ä¼˜åŒ–å)
- **è°ƒåº¦å™¨è´Ÿè½½**: æ’å®š,ä¸ä»»åŠ¡æ€»æ•°æ— å…³

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

**åç«¯æ–°å¢æ–‡ä»¶**:
1. `backend/app/services/dingtalk_service.py` - é’‰é’‰æ¶ˆæ¯æœåŠ¡
2. `backend/app/services/task_reminder_service.py` - ä»»åŠ¡æé†’è°ƒåº¦æœåŠ¡
3. `backend/app/core/scheduler.py` - APScheduleré›†æˆ

**åç«¯ä¿®æ”¹æ–‡ä»¶**:
1. `backend/requirements.txt` - æ·»åŠ ä¾èµ–
2. `backend/.env.example` - æ·»åŠ é…ç½®ç¤ºä¾‹
3. `backend/app/core/config.py` - æ·»åŠ é’‰é’‰é…ç½®ç±»
4. `backend/app/db/models.py` - Taskæ¨¡å‹æ·»åŠ å­—æ®µ
5. `backend/app/schemas/task.py` - Task schemaæ·»åŠ å­—æ®µ
6. `backend/app/schemas/settings.py` - æ·»åŠ é’‰é’‰é…ç½®schema
7. `backend/app/api/endpoints/settings.py` - æ‰©å±•é…ç½®API
8. `backend/app/main.py` - é›†æˆè°ƒåº¦å™¨å¯åŠ¨/å…³é—­

**å‰ç«¯ä¿®æ”¹æ–‡ä»¶**:
1. `frontend/src/views/SettingsView.vue` - æ·»åŠ é’‰é’‰é…ç½®UI

### B. å‚è€ƒèµ„æ–™

- [APScheduler å®˜æ–¹æ–‡æ¡£](https://apscheduler.readthedocs.io/en/3.x/)
- [DingtalkChatbot GitHub](https://github.com/zhuifengshen/DingtalkChatbot)
- [é’‰é’‰è‡ªå®šä¹‰æœºå™¨äººæ–‡æ¡£](https://open.dingtalk.com/document/group/custom-robot-access)
- [PostgreSQL Interval æ–‡æ¡£](https://www.postgresql.org/docs/current/datatype-datetime.html)

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£åº”éšåŠŸèƒ½è¿­ä»£åŒæ­¥æ›´æ–°
